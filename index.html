<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#9333ea">
  <title>WineScan - Wine Collection Tracker</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/4.1.1/tesseract.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #faf5ff 0%, #fce7f3 100%);
      min-height: 100vh;
      padding-bottom: 20px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
    }

    .header {
      background: linear-gradient(135deg, #9333ea 0%, #ec4899 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .header h1 {
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s;
      width: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, #9333ea 0%, #ec4899 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(147, 51, 234, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(147, 51, 234, 0.4);
    }

    .btn-secondary {
      background: white;
      color: #9333ea;
      border: 2px solid #9333ea;
    }

    .btn-secondary:hover {
      background: #faf5ff;
    }

    .content {
      padding: 20px;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }

    .wine-icon {
      font-size: 64px;
      text-align: center;
      margin-bottom: 20px;
    }

    .text-center {
      text-align: center;
    }

    h2 {
      font-size: 24px;
      margin-bottom: 8px;
      color: #1f2937;
    }

    .subtitle {
      color: #6b7280;
      margin-bottom: 24px;
    }

    .wine-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .wine-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .wine-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .wine-emoji {
      font-size: 40px;
    }

    .wine-info {
      flex: 1;
    }

    .wine-name {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .wine-meta {
      font-size: 14px;
      color: #6b7280;
    }

    .stars {
      display: flex;
      gap: 4px;
      margin-top: 4px;
    }

    .star {
      color: #fbbf24;
      font-size: 16px;
    }

    .star.empty {
      color: #d1d5db;
    }

    .hidden {
      display: none !important;
    }

    .camera-container {
      position: relative;
      width: 100%;
      height: 500px;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #barcode-scanner {
      width: 100%;
      height: 100%;
    }

    #barcode-scanner video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    #barcode-scanner canvas {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
    }

    .camera-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 3px dashed rgba(255, 255, 255, 0.8);
      width: 70%;
      height: 75%;
      border-radius: 12px;
      pointer-events: none;
    }

    .camera-hint {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
      max-width: 80%;
      z-index: 10;
    }

    .camera-controls {
      position: absolute;
      bottom: 20px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      z-index: 10;
    }

    .capture-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: white;
      border: 4px solid #9333ea;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .capture-btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #9333ea;
    }

    .capture-btn:active {
      transform: scale(0.9);
    }

    .flip-camera-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    canvas {
      max-width: 100%;
      border-radius: 12px;
    }

    .processing {
      text-align: center;
      padding: 40px 20px;
    }

    .spinner {
      border: 4px solid #f3f4f6;
      border-top: 4px solid #9333ea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
      font-size: 14px;
    }

    input, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      font-family: inherit;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #9333ea;
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .rating-input {
      display: flex;
      gap: 8px;
      margin-top: 8px;
    }

    .rating-star {
      font-size: 32px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .rating-star:hover {
      transform: scale(1.2);
    }

    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .btn-danger {
      background: #fee;
      color: #dc2626;
      border: none;
    }

    .btn-danger:hover {
      background: #fdd;
    }

    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .close-btn:hover {
      background: rgba(255,255,255,0.2);
    }

    .image-preview {
      width: 100%;
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #9333ea 0%, #ec4899 100%);
      color: white;
      border: none;
      font-size: 32px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(147, 51, 234, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(147, 51, 234, 0.5);
    }

    .file-input {
      display: none;
    }

    .option-buttons {
      display: flex;
      gap: 12px;
      flex-direction: column;
    }

    .help-text {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }

    .skip-scan {
      margin-top: 12px;
      text-align: center;
    }

    .skip-scan button {
      background: none;
      border: none;
      color: #9333ea;
      text-decoration: underline;
      cursor: pointer;
      font-size: 14px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <h1>
          <span>üç∑</span>
          <span>WineScan</span>
        </h1>
        <button class="close-btn hidden" onclick="goHome()">√ó</button>
      </div>
    </div>

    <!-- Home View -->
    <div id="homeView" class="content">
      <div class="card text-center">
        <div class="wine-icon">üç∑</div>
        <h2>Discover & Track Wines</h2>
        <p class="subtitle">Scan labels, save favorites, build your collection</p>
        
        <div class="option-buttons">
          <button class="btn btn-primary" onclick="startBarcodeScanner()">
            <span>üìä</span>
            <span>Scan Barcode</span>
          </button>
          
          <button class="btn btn-secondary" onclick="startCamera()">
            <span>üì∑</span>
            <span>Take Photo (OCR)</span>
          </button>
          
          <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
            <span>üñºÔ∏è</span>
            <span>Upload from Library</span>
          </button>
          
          <button class="btn btn-secondary" onclick="manualEntry()">
            <span>‚úçÔ∏è</span>
            <span>Enter Manually</span>
          </button>
        </div>
        
        <input type="file" id="fileInput" class="file-input" accept="image/*" onchange="handleFileUpload(event)">
        
        <div style="height: 24px"></div>
        <button class="btn btn-secondary" onclick="showCollection()">
          <span>üç∑</span>
          <span id="collectionCount">My Collection (0)</span>
        </button>
      </div>
    </div>

    <!-- Barcode Scanner View -->
    <div id="barcodeView" class="content hidden">
      <div class="card">
        <h2>Scan Barcode</h2>
        <p class="subtitle">Position barcode horizontally in frame</p>
        <div class="camera-container">
          <div id="barcode-scanner"></div>
          <div class="camera-hint" id="barcodeHint">Align barcode with red line</div>
        </div>
        <div class="skip-scan">
          <button onclick="manualEntry()">Skip and enter manually</button>
        </div>
        <div style="height: 12px"></div>
        <button class="btn btn-secondary" onclick="stopBarcodeScanner()">Cancel</button>
      </div>
    </div>

    <!-- Camera View -->
    <div id="cameraView" class="content hidden">
      <div class="card">
        <h2>Scan Wine Label</h2>
        <p class="subtitle">Center the label in the frame</p>
        <div class="camera-container">
          <video id="video" autoplay playsinline></video>
          <div class="camera-overlay"></div>
          <div class="camera-hint">Position label vertically in frame</div>
          <div class="camera-controls">
            <button class="flip-camera-btn" onclick="flipCamera()">üîÑ</button>
            <button class="capture-btn" onclick="capturePhoto()"></button>
          </div>
        </div>
        <div class="skip-scan">
          <button onclick="manualEntry()">Skip scan and enter manually</button>
        </div>
        <div style="height: 12px"></div>
        <button class="btn btn-secondary" onclick="goHome()">Cancel</button>
      </div>
    </div>

    <!-- Processing View -->
    <div id="processingView" class="content hidden">
      <div class="card processing">
        <div class="spinner"></div>
        <h2>Processing...</h2>
        <p class="subtitle" id="processingStatus">Extracting wine information</p>
      </div>
    </div>

    <!-- Result View -->
    <div id="resultView" class="content hidden">
      <div class="card">
        <img id="capturedImage" class="image-preview" alt="Wine label">
        <h2>Wine Details</h2>
        <p class="subtitle">Edit any fields as needed</p>
        
        <div class="form-group">
          <label>Wine Name *</label>
          <input type="text" id="wineName" placeholder="e.g., Ch√¢teau Margaux">
          <div class="help-text">Required field</div>
        </div>
        
        <div class="form-group">
          <label>Vintage Year</label>
          <input type="number" id="wineVintage" placeholder="e.g., 2018" min="1900" max="2025">
        </div>
        
        <div class="form-group">
          <label>Producer / Winery</label>
          <input type="text" id="wineProducer" placeholder="e.g., Ch√¢teau Margaux">
        </div>
        
        <div class="form-group">
          <label>Region / Appellation</label>
          <input type="text" id="wineRegion" placeholder="e.g., Bordeaux, France">
        </div>
        
        <div class="form-group">
          <label>Varietal / Blend</label>
          <input type="text" id="wineVarietal" placeholder="e.g., Cabernet Sauvignon">
        </div>
        
        <div class="btn-group">
          <button class="btn btn-primary" onclick="saveWine()" style="flex: 2">
            <span>üíæ</span>
            <span>Save to Collection</span>
          </button>
          <button class="btn btn-secondary" onclick="goHome()" style="flex: 1">
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Collection View -->
    <div id="collectionView" class="content hidden">
      <h2 style="margin-bottom: 16px; color: #1f2937;">My Wines</h2>
      <div id="wineList" class="wine-list"></div>
      <div id="emptyState" class="card text-center hidden">
        <div class="wine-icon">üç∑</div>
        <h2>No wines yet</h2>
        <p class="subtitle">Start scanning to build your collection!</p>
      </div>
    </div>

    <!-- Detail View -->
    <div id="detailView" class="content hidden">
      <div class="card" id="detailCard"></div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab hidden" id="fab" onclick="startBarcodeScanner()">üìä</button>
  </div>

  <script>
    let wines = JSON.parse(localStorage.getItem('wines') || '[]');
    let currentWineId = null;
    let stream = null;
    let facingMode = 'environment';
    let barcodeScanning = false;

    function showView(viewId) {
      ['homeView', 'cameraView', 'barcodeView', 'processingView', 'resultView', 'collectionView', 'detailView'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
      });
      document.getElementById(viewId).classList.remove('hidden');
      
      document.querySelector('.close-btn').classList.toggle('hidden', viewId === 'homeView');
      document.getElementById('fab').classList.toggle('hidden', viewId === 'homeView' || viewId === 'cameraView' || viewId === 'barcodeView');
    }

    function goHome() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      stopBarcodeScanner();
      showView('homeView');
    }

    function startBarcodeScanner() {
      showView('barcodeView');
      barcodeScanning = true;
      
      Quagga.init({
        inputStream: {
          name: "Live",
          type: "LiveStream",
          target: document.querySelector('#barcode-scanner'),
          constraints: {
            facingMode: "environment"
          }
        },
        decoder: {
          readers: ["ean_reader", "ean_8_reader", "upc_reader", "upc_e_reader", "code_128_reader"]
        },
        locate: true
      }, function(err) {
        if (err) {
          console.error(err);
          alert('Could not access camera for barcode scanning. Please check camera permissions or try manual entry.');
          goHome();
          return;
        }
        Quagga.start();
      });

      Quagga.onDetected(function(result) {
        if (!barcodeScanning) return;
        
        const code = result.codeResult.code;
        console.log("Barcode detected:", code);
        document.getElementById('barcodeHint').textContent = `Found: ${code} - Searching...`;
        
        // Prevent multiple scans
        barcodeScanning = false;
        
        // Stop scanner and search for wine
        setTimeout(() => {
          stopBarcodeScanner();
          searchWineByBarcode(code);
        }, 500);
      });
    }

    function stopBarcodeScanner() {
      barcodeScanning = false;
      try {
        Quagga.stop();
      } catch(e) {
        // Quagga not running
      }
    }

    async function searchWineByBarcode(barcode) {
      showView('processingView');
      document.getElementById('processingStatus').textContent = 'Searching wine database...';
      
      try {
        // Try Open Food Facts API (free, has wine data)
        const response = await fetch(`https://world.openfoodfacts.org/api/v0/product/${barcode}.json`);
        const data = await response.json();
        
        if (data.status === 1 && data.product) {
          const product = data.product;
          
          // Extract wine information
          const wineName = product.product_name || product.brands || '';
          const vintage = (product.product_name || '').match(/\b(19[5-9]\d|20[0-2]\d)\b/)?.[0] || '';
          
          // Try to get product image or create placeholder
          let imageUrl;
          if (product.image_url) {
            imageUrl = product.image_url;
          } else {
            imageUrl = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300"><rect fill="%239333ea" width="400" height="300"/><text x="50%" y="40%" fill="white" font-size="48" text-anchor="middle" dy=".3em">üç∑</text><text x="50%" y="65%" fill="white" font-size="14" text-anchor="middle" dy=".3em">Barcode: ${barcode}</text></svg>`;
          }
          
          document.getElementById('capturedImage').src = imageUrl;
          document.getElementById('wineName').value = wineName;
          document.getElementById('wineVintage').value = vintage;
          document.getElementById('wineProducer').value = product.brands || '';
          document.getElementById('wineRegion').value = product.origins || '';
          document.getElementById('wineVarietal').value = '';
          
          showView('resultView');
        } else {
          // No data found for this barcode
          alert(`Barcode ${barcode} not found in wine database. Please enter the details manually.`);
          
          // Show form with barcode info
          const placeholderImage = `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300"><rect fill="%239333ea" width="400" height="300"/><text x="50%" y="40%" fill="white" font-size="48" text-anchor="middle" dy=".3em">üç∑</text><text x="50%" y="65%" fill="white" font-size="14" text-anchor="middle" dy=".3em">Barcode: ${barcode}</text></svg>`;
          
          document.getElementById('capturedImage').src = placeholderImage;
          document.getElementById('wineName').value = '';
          document.getElementById('wineVintage').value = '';
          document.getElementById('wineProducer').value = '';
          document.getElementById('wineRegion').value = '';
          document.getElementById('wineVarietal').value = '';
          
          showView('resultView');
        }
      } catch (error) {
        console.error('Error searching barcode:', error);
        alert('Could not search wine database. Please check your internet connection or enter details manually.');
        manualEntry();
      }
    }

    async function startCamera() {
      showView('cameraView');
      try {
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: facingMode },
          audio: false 
        });
        document.getElementById('video').srcObject = stream;
      } catch (err) {
        alert('Camera access denied. Please enable camera permissions in your browser settings.');
        goHome();
      }
    }

    async function flipCamera() {
      facingMode = facingMode === 'environment' ? 'user' : 'environment';
      await startCamera();
    }

    function capturePhoto() {
      const video = document.getElementById('video');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }

      const imageData = canvas.toDataURL('image/jpeg', 0.9);
      processImage(imageData);
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          processImage(e.target.result);
        };
        reader.readAsDataURL(file);
      }
    }

    async function processImage(imageData) {
      showView('processingView');
      document.getElementById('processingStatus').textContent = 'Analyzing wine label with AI...';
      
      try {
        // Use Claude API to analyze the wine label
        const response = await fetch("https://api.anthropic.com/v1/messages", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            model: "claude-sonnet-4-20250514",
            max_tokens: 1000,
            messages: [
              {
                role: "user",
                content: [
                  {
                    type: "image",
                    source: {
                      type: "base64",
                      media_type: "image/jpeg",
                      data: imageData.split(',')[1]
                    }
                  },
                  {
                    type: "text",
                    text: `Analyze this wine label and extract the following information. Return ONLY a JSON object with these fields (use empty strings if information is not visible):

{
  "name": "full wine name",
  "vintage": "year only (e.g., 2018)",
  "producer": "winery or ch√¢teau name",
  "region": "region and country (e.g., Bordeaux, France)",
  "varietal": "grape variety or blend type"
}

Be precise and only include information you can clearly see on the label. If you cannot see the label or this is not a wine bottle, return all empty strings.`
                  }
                ]
              }
            ]
          })
        });

        const data = await response.json();
        
        if (data.content && data.content[0] && data.content[0].text) {
          let responseText = data.content[0].text.trim();
          
          // Remove markdown code fences if present
          responseText = responseText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
          
          const wineData = JSON.parse(responseText);
          
          document.getElementById('capturedImage').src = imageData;
          document.getElementById('wineName').value = wineData.name || '';
          document.getElementById('wineVintage').value = wineData.vintage || '';
          document.getElementById('wineProducer').value = wineData.producer || '';
          document.getElementById('wineRegion').value = wineData.region || '';
          document.getElementById('wineVarietal').value = wineData.varietal || '';
          
          showView('resultView');
          
          // Show helpful message if AI couldn't identify the wine
          if (!wineData.name && !wineData.vintage) {
            alert('Could not identify wine details from the image. Please enter manually or try a clearer photo.');
          }
        } else {
          throw new Error('Invalid API response');
        }
        
      } catch (err) {
        console.error('AI Analysis Error:', err);
        alert('Could not analyze the wine label. Please enter details manually or try again.');
        manualEntry();
      }
    }

    function manualEntry() {
      document.getElementById('capturedImage').src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300"><rect fill="%239333ea" width="400" height="300"/><text x="50%" y="50%" fill="white" font-size="48" text-anchor="middle" dy=".3em">üç∑</text></svg>';
      document.getElementById('wineName').value = '';
      document.getElementById('wineVintage').value = '';
      document.getElementById('wineProducer').value = '';
      document.getElementById('wineRegion').value = '';
      document.getElementById('wineVarietal').value = '';
      showView('resultView');
    }

    function saveWine() {
      const name = document.getElementById('wineName').value.trim();
      
      if (!name) {
        alert('Please enter a wine name');
        document.getElementById('wineName').focus();
        return;
      }
      
      const wine = {
        id: Date.now(),
        name: name,
        vintage: document.getElementById('wineVintage').value || '',
        producer: document.getElementById('wineProducer').value || '',
        region: document.getElementById('wineRegion').value || '',
        varietal: document.getElementById('wineVarietal').value || '',
        rating: 0,
        notes: '',
        image: document.getElementById('capturedImage').src,
        dateAdded: new Date().toISOString().split('T')[0]
      };
      
      wines.unshift(wine);
      localStorage.setItem('wines', JSON.stringify(wines));
      updateCollectionCount();
      showCollection();
    }

    function showCollection() {
      const list = document.getElementById('wineList');
      const empty = document.getElementById('emptyState');
      
      if (wines.length === 0) {
        list.innerHTML = '';
        empty.classList.remove('hidden');
      } else {
        empty.classList.add('hidden');
        list.innerHTML = wines.map(wine => `
          <div class="wine-item" onclick="showDetail(${wine.id})">
            <div class="wine-emoji">üç∑</div>
            <div class="wine-info">
              <div class="wine-name">${wine.name}</div>
              <div class="wine-meta">
                ${wine.vintage ? wine.vintage + ' ‚Ä¢ ' : ''}${wine.region || wine.producer || 'Unknown region'}
              </div>
              <div class="stars">
                ${[...Array(5)].map((_, i) => 
                  `<span class="star ${i >= wine.rating ? 'empty' : ''}">‚òÖ</span>`
                ).join('')}
              </div>
            </div>
          </div>
        `).join('');
      }
      
      showView('collectionView');
    }

    function showDetail(id) {
      const wine = wines.find(w => w.id === id);
      currentWineId = id;
      
      const card = document.getElementById('detailCard');
      card.innerHTML = `
        <img src="${wine.image}" class="image-preview" alt="Wine label">
        <h2>${wine.name}</h2>
        <p class="subtitle">${wine.vintage || 'Vintage not specified'}</p>
        
        ${wine.producer ? `<div class="form-group">
          <label>Producer</label>
          <div style="color: #6b7280">${wine.producer}</div>
        </div>` : ''}
        
        ${wine.region ? `<div class="form-group">
          <label>Region</label>
          <div style="color: #6b7280">${wine.region}</div>
        </div>` : ''}
        
        ${wine.varietal ? `<div class="form-group">
          <label>Varietal</label>
          <div style="color: #6b7280">${wine.varietal}</div>
        </div>` : ''}
        
        <div class="form-group">
          <label>My Rating</label>
          <div class="rating-input">
            ${[...Array(5)].map((_, i) => 
              `<span class="rating-star ${i >= wine.rating ? 'empty' : ''}" onclick="updateRating(${i + 1})">‚òÖ</span>`
            ).join('')}
          </div>
        </div>
        
        <div class="form-group">
          <label>Tasting Notes</label>
          <textarea id="wineNotes" placeholder="Add your tasting notes, food pairings, or memories...">${wine.notes}</textarea>
        </div>
        
        <div class="form-group">
          <label>Date Added</label>
          <div style="color: #6b7280">${wine.dateAdded}</div>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-primary" onclick="saveNotes()">
            <span>üíæ</span>
            <span>Save Notes</span>
          </button>
          <button class="btn btn-danger" onclick="deleteWine()">
            üóëÔ∏è Delete
          </button>
        </div>
      `;
      
      showView('detailView');
    }

    function updateRating(rating) {
      const wine = wines.find(w => w.id === currentWineId);
      wine.rating = rating;
      localStorage.setItem('wines', JSON.stringify(wines));
      showDetail(currentWineId);
    }

    function saveNotes() {
      const wine = wines.find(w => w.id === currentWineId);
      wine.notes = document.getElementById('wineNotes').value;
      localStorage.setItem('wines', JSON.stringify(wines));
      alert('Notes saved!');
    }

    function deleteWine() {
      if (confirm('Delete this wine from your collection?')) {
        wines = wines.filter(w => w.id !== currentWineId);
        localStorage.setItem('wines', JSON.stringify(wines));
        updateCollectionCount();
        showCollection();
      }
    }

    function updateCollectionCount() {
      document.getElementById('collectionCount').textContent = `My Collection (${wines.length})`;
    }

    // Initialize
    updateCollectionCount();
  </script>
</body>
</html>
