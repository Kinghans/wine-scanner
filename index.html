<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <title>WineScan v3.0</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #faf5ff 0%, #fce7f3 100%);
      min-height: 100vh;
      padding-bottom: 20px;
    }
    .container { max-width: 500px; margin: 0 auto; }
    .header {
      background: linear-gradient(135deg, #722F37 0%, #8B3A42 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-content { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .header h1 { font-size: 24px; display: flex; align-items: center; gap: 10px; }
    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s;
      width: 100%;
    }
    .btn-primary { background: linear-gradient(135deg, #722F37 0%, #8B3A42 100%); color: white; box-shadow: 0 4px 12px rgba(114, 47, 55, 0.3); }
    .btn-secondary { background: white; color: #722F37; border: 2px solid #722F37; }
    .btn-danger { background: #fee; color: #dc2626; border: none; }
    .content { padding: 20px; }
    .card { background: white; border-radius: 16px; padding: 24px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 16px; }
    .wine-icon { font-size: 64px; text-align: center; margin-bottom: 20px; }
    .text-center { text-align: center; }
    h2 { font-size: 24px; margin-bottom: 8px; color: #1f2937; }
    .subtitle { color: #6b7280; margin-bottom: 24px; }
    .wine-list { display: flex; flex-direction: column; gap: 12px; }
    .wine-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      gap: 16px;
      align-items: center;
    }
    .wine-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
    .wine-item-image { width: 60px; height: 60px; border-radius: 8px; object-fit: cover; flex-shrink: 0; }
    .wine-emoji {
      font-size: 40px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: linear-gradient(135deg, #f3e8ff 0%, #fce7f3 100%);
      border-radius: 8px;
    }
    .wine-info { flex: 1; }
    .wine-name { font-weight: 600; color: #1f2937; margin-bottom: 4px; }
    .wine-meta { font-size: 14px; color: #6b7280; }
    .rank-section { display: flex; gap: 4px; margin-top: 4px; align-items: center; }
    .rank-badge {
      background: linear-gradient(135deg, #722F37 0%, #8B3A42 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
    }
    .rank-badge.unranked { background: #e5e7eb; color: #6b7280; }
    .hidden { display: none !important; }
    .camera-container { position: relative; width: 100%; height: 500px; background: #000; border-radius: 12px; overflow: hidden; margin-bottom: 16px; }
    video { width: 100%; height: 100%; object-fit: cover; }
    .camera-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 3px dashed rgba(255, 255, 255, 0.8);
      width: 70%;
      height: 75%;
      border-radius: 12px;
      pointer-events: none;
    }
    .camera-hint {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
      max-width: 80%;
      z-index: 10;
    }
    .camera-controls { position: absolute; bottom: 20px; left: 0; right: 0; display: flex; justify-content: center; align-items: center; gap: 20px; z-index: 10; }
    .capture-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: white;
      border: 4px solid #722F37;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .capture-btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #722F37;
    }
    .flip-camera-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .processing { text-align: center; padding: 40px 20px; }
    .spinner {
      border: 4px solid #f3f4f6;
      border-top: 4px solid #722F37;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    .form-group { margin-bottom: 16px; }
    label { display: block; font-weight: 600; margin-bottom: 8px; color: #374151; font-size: 14px; }
    input, textarea { width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 16px; font-family: inherit; }
    input:focus, textarea:focus { outline: none; border-color: #722F37; }
    textarea { resize: vertical; min-height: 100px; }
    .btn-group { display: flex; gap: 12px; margin-top: 24px; }
    .close-btn, .settings-btn {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s;
    }
    .close-btn { font-size: 28px; }
    .image-preview { width: 100%; border-radius: 12px; margin-bottom: 16px; }
    .image-placeholder {
      text-align: center;
      padding: 60px;
      background: linear-gradient(135deg, #f3e8ff 0%, #fce7f3 100%);
      border-radius: 12px;
      margin-bottom: 16px;
    }
    .image-placeholder .icon { font-size: 120px; }
    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #722F37 0%, #8B3A42 100%);
      color: white;
      border: none;
      font-size: 32px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(114, 47, 55, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .file-input { display: none; }
    .option-buttons { display: flex; gap: 12px; flex-direction: column; }
    .help-text { font-size: 12px; color: #6b7280; margin-top: 4px; }
    .skip-scan { margin-top: 12px; text-align: center; }
    .skip-scan button { background: none; border: none; color: #722F37; text-decoration: underline; cursor: pointer; font-size: 14px; }
    .comparison-options { display: flex; gap: 12px; margin-bottom: 24px; }
    .wine-comparison-card {
      flex: 1;
      background: white;
      border: 3px solid #e5e7eb;
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }
    .wine-comparison-card:hover { transform: translateY(-4px); border-color: #722F37; box-shadow: 0 8px 20px rgba(114, 47, 55, 0.2); }
    .wine-comparison-card img { width: 100%; height: 150px; object-fit: cover; border-radius: 12px; margin-bottom: 12px; }
    .wine-comparison-card .wine-icon-large {
      font-size: 64px;
      margin-bottom: 12px;
      padding: 20px;
      background: linear-gradient(135deg, #f3e8ff 0%, #fce7f3 100%);
      border-radius: 12px;
    }
    .wine-comparison-card h3 { font-size: 16px; margin-bottom: 4px; color: #1f2937; }
    .wine-comparison-card .vintage { font-size: 14px; color: #6b7280; }
    .comparison-prompt { text-align: center; margin-bottom: 24px; color: #6b7280; font-size: 18px; font-weight: 500; }
    .type-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 8px;
      font-weight: 600;
      font-size: 14px;
      color: white;
      margin-bottom: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-content">
        <h1><span>üç∑</span><span>Grapevine</span></h1>
        <div style="display: flex; gap: 8px;">
          <button class="settings-btn" onclick="showSettings()">‚öôÔ∏è</button>
          <button class="close-btn hidden" onclick="goHome()">√ó</button>
        </div>
      </div>
    </div>

    <div id="homeView" class="content">
      <div class="card text-center">
        <div class="wine-icon">üç∑</div>
        <h2>Discover & Track Wines</h2>
        <p class="subtitle">Build your collection or discover new wines</p>
        <div class="option-buttons">
          <button class="btn btn-primary" onclick="showAddOptions()">
            <span>‚ûï</span><span>Add Wine to Collection</span>
          </button>
          <button class="btn btn-secondary" onclick="showLearnOptions()">
            <span>üîç</span><span>Learn About a Wine</span>
          </button>
          <button class="btn btn-secondary" onclick="showDineOptions()">
            <span>üçΩÔ∏è</span><span>Dine - Scan Menu</span>
          </button>
        </div>
        <div style="height: 24px"></div>
        <button class="btn btn-secondary" onclick="showCollection()">
          <span>üç∑</span><span id="collectionCount">My Collection (0)</span>
        </button>
        <div style="height: 12px"></div>
        <button class="btn btn-secondary" onclick="showWishlist()">
          <span>‚≠ê</span><span id="wishlistCount">Saved Wines (0)</span>
        </button>
      </div>
    </div>

    <div id="addOptionsView" class="content hidden">
      <div class="card text-center">
        <h2>Add Wine to Collection</h2>
        <p class="subtitle">How would you like to add this wine?</p>
        <div class="option-buttons">
          <button class="btn btn-primary" onclick="startCamera('add')">
            <span>üì∑</span><span>Take Photo</span>
          </button>
          <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
            <span>üñºÔ∏è</span><span>Upload from Library</span>
          </button>
          <button class="btn btn-secondary" onclick="manualEntry()">
            <span>‚úçÔ∏è</span><span>Enter Manually</span>
          </button>
        </div>
        <input type="file" id="fileInput" class="file-input" accept="image/*" onchange="handleFileUpload(event)">
        <div style="height: 12px"></div>
        <button class="btn btn-secondary" onclick="goHome()">Back</button>
      </div>
    </div>

    <div id="learnOptionsView" class="content hidden">
      <div class="card text-center">
        <h2>Learn About a Wine</h2>
        <p class="subtitle">Get detailed information about any wine</p>
        <div class="option-buttons">
          <button class="btn btn-primary" onclick="startCamera('learn')">
            <span>üì∑</span><span>Scan Wine Label</span>
          </button>
          <button class="btn btn-secondary" onclick="searchWineManually()">
            <span>üîé</span><span>Search by Name</span>
          </button>
        </div>
        <div style="height: 12px"></div>
        <button class="btn btn-secondary" onclick="goHome()">Back</button>
      </div>
    </div>

    <div id="cameraView" class="content hidden">
      <div class="card">
        <h2 id="cameraTitle">Scan Wine Label</h2>
        <p class="subtitle" id="cameraSubtitle">Center the label in the frame</p>
        <div class="camera-container">
          <video id="video" autoplay playsinline></video>
          <div class="camera-overlay"></div>
          <div class="camera-hint">Position label vertically in frame</div>
          <div class="camera-controls">
            <button class="flip-camera-btn" onclick="flipCamera()">üîÑ</button>
            <button class="capture-btn" onclick="capturePhoto()"></button>
          </div>
        </div>
        <div class="skip-scan"><button onclick="currentMode === 'learn' ? showLearnOptions() : manualEntry()">Skip</button></div>
        <div style="height: 12px"></div>
        <button class="btn btn-secondary" onclick="goHome()">Cancel</button>
      </div>
    </div>

    <div id="processingView" class="content hidden">
      <div class="card processing">
        <div class="spinner"></div>
        <h2>Processing...</h2>
        <p class="subtitle" id="processingStatus">Please wait</p>
      </div>
    </div>

    <div id="resultView" class="content hidden">
      <div class="card">
        <div id="imageContainer"></div>
        <h2>Wine Details</h2>
        <p class="subtitle">Edit any fields as needed</p>
        <div class="form-group">
          <label>Wine Name *</label>
          <input type="text" id="wineName" placeholder="e.g., Ch√¢teau Margaux">
          <div class="help-text">Required field</div>
        </div>
        <div class="form-group">
          <label>Vintage Year</label>
          <input type="number" id="wineVintage" placeholder="e.g., 2018" min="1900" max="2025">
        </div>
        <div class="form-group">
          <label>Producer / Winery</label>
          <input type="text" id="wineProducer" placeholder="e.g., Ch√¢teau Margaux">
        </div>
        <div class="form-group">
          <label>Region / Appellation</label>
          <input type="text" id="wineRegion" placeholder="e.g., Bordeaux, France">
        </div>
        <div class="form-group">
          <label>Varietal / Blend</label>
          <input type="text" id="wineVarietal" placeholder="e.g., Cabernet Sauvignon">
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="saveWine()" style="flex: 2">
            <span>üíæ</span><span>Save to Collection</span>
          </button>
          <button class="btn btn-secondary" onclick="goHome()" style="flex: 1">Cancel</button>
        </div>
      </div>
    </div>

    <div id="searchView" class="content hidden">
      <div class="card">
        <h2>Search Wine</h2>
        <p class="subtitle">Enter the wine name to search</p>
        <div class="form-group">
          <label>Wine Name</label>
          <input type="text" id="searchWineName" placeholder="e.g., Ch√¢teau Margaux 2015">
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="searchWineByName()">
            <span>üîç</span><span>Search</span>
          </button>
          <button class="btn btn-secondary" onclick="showLearnOptions()">Cancel</button>
        </div>
      </div>
    </div>

    <div id="learnResultView" class="content hidden">
      <div class="card">
        <div id="learnImageContainer"></div>
        <h2 id="learnWineName">Wine Name</h2>
        <div id="learnWineInfo"></div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="saveToWishlist()">
            <span>‚≠ê</span><span>Save for Later</span>
          </button>
          <button class="btn btn-secondary" onclick="addLearnedWineToCollection()">
            <span>‚ûï</span><span>Add to Collection</span>
          </button>
        </div>
        <div style="height: 12px"></div>
        <button class="btn btn-secondary" onclick="showLearnOptions()">Search Another</button>
        <div style="height: 12px"></div>
        <button class="btn btn-secondary" onclick="goHome()">Back to Home</button>
      </div>
    </div>

    <div id="collectionView" class="content hidden">
      <h2 style="margin-bottom: 16px; color: #1f2937;">My Wines</h2>
      <div id="wineList" class="wine-list"></div>
      <div id="emptyState" class="card text-center hidden">
        <div class="wine-icon">üç∑</div>
        <h2>No wines yet</h2>
        <p class="subtitle">Start scanning to build your collection!</p>
      </div>
    </div>

    <div id="detailView" class="content hidden">
      <div class="card" id="detailCard"></div>
    </div>

    <div id="settingsView" class="content hidden">
      <div class="card">
        <h2>Settings</h2>
        <p class="subtitle">Configure AI wine recognition</p>
        <div class="form-group">
          <label>OpenAI API Key</label>
          <input type="password" id="apiKeyInput" placeholder="sk-...">
          <div class="help-text">Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #722F37;">platform.openai.com</a></div>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="saveSettings()">
            <span>üíæ</span><span>Save API Key</span>
          </button>
          <button class="btn btn-secondary" onclick="goHome()">Cancel</button>
        </div>
      </div>
    </div>

    <div id="sentimentView" class="content hidden">
      <div class="card text-center">
        <div class="wine-icon">üç∑</div>
        <h2 id="sentimentWineName">Wine Name</h2>
        <p class="subtitle">How did you feel about this wine?</p>
        <div class="option-buttons">
          <button class="btn btn-primary" onclick="setSentiment('yes')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
            <span>üòç</span><span>I Loved It</span>
          </button>
          <button class="btn btn-secondary" onclick="setSentiment('ok')">
            <span>üòä</span><span>It Was OK</span>
          </button>
          <button class="btn btn-secondary" onclick="setSentiment('no')" style="border-color: #dc2626; color: #dc2626;">
            <span>üòê</span><span>Didn't Like It</span>
          </button>
        </div>
        <div style="margin-top: 24px;">
          <button class="btn btn-secondary" onclick="skipRanking()">Skip Ranking</button>
        </div>
      </div>
    </div>

    <div id="comparisonView" class="content hidden">
      <div class="card">
        <h2>Rank Your Wine</h2>
        <p class="comparison-prompt">Which wine did you prefer?</p>
        <div class="comparison-options" id="comparisonOptions"></div>
        <button class="btn btn-secondary" onclick="finishRanking()">Done Ranking</button>
      </div>
    </div>

    <div id="dineOptionsView" class="content hidden">
      <div class="card text-center">
        <h2>Scan Restaurant Menu</h2>
        <p class="subtitle">Get details on all wines from a menu</p>
        <div class="option-buttons">
          <button class="btn btn-primary" onclick="startCamera('menu')">
            <span>üì∏</span><span>Scan Wine Menu</span>
          </button>
        </div>
        <div style="height: 12px"></div>
        <button class="btn btn-secondary" onclick="goHome()">Back</button>
      </div>
    </div>

    <div id="menuResultView" class="content hidden">
      <div class="card">
        <h2>Wines on Menu</h2>
        <p class="subtitle">Tap a wine to see tasting notes</p>
        <div id="menuWineList" class="wine-list"></div>
        <div style="height: 12px"></div>
        <button class="btn btn-secondary" onclick="showDineOptions()">Scan Another Menu</button>
        <div style="height: 8px"></div>
        <button class="btn btn-secondary" onclick="goHome()">Back to Home</button>
      </div>
    </div>

    <div id="wishlistView" class="content hidden">
      <h2 style="margin-bottom: 16px; color: #1f2937;">Saved Wines</h2>
      <p class="subtitle" style="margin-bottom: 16px;">Wines you want to try or buy later</p>
      <div id="wishlistList" class="wine-list"></div>
      <div id="wishlistEmptyState" class="card text-center hidden">
        <div class="wine-icon">‚≠ê</div>
        <h2>No saved wines yet</h2>
        <p class="subtitle">Use "Learn About a Wine" to discover and save wines for later!</p>
      </div>
    </div>

    <div id="wishlistDetailView" class="content hidden">
      <div class="card" id="wishlistDetailCard"></div>
    </div>

    <button class="fab hidden" id="fab" onclick="showAddOptions()">‚ûï</button>
  </div>

  <script>
    let wines = JSON.parse(localStorage.getItem('wines') || '[]');
    let wishlist = JSON.parse(localStorage.getItem('wishlist') || '[]');
    let currentWineId = null;
    let stream = null;
    let facingMode = 'environment';
    let currentComparison = null;
    let currentImageData = null;
    let currentMode = 'add';
    let learnedWineData = null;
    let menuWines = [];

    function isValidImage(img) {
      return img && typeof img === 'string' && img.startsWith('data:image/') && img.length > 100;
    }

    wines = wines.map(w => ({...w, image: isValidImage(w.image) ? w.image : null, score: w.score || null, sentiment: w.sentiment || null, comparisons: w.comparisons || 0}));
    localStorage.setItem('wines', JSON.stringify(wines));

    function showView(v) {
      ['homeView','addOptionsView','learnOptionsView','dineOptionsView','cameraView','processingView','resultView','searchView','learnResultView','menuResultView','collectionView','detailView','wishlistView','wishlistDetailView','settingsView','sentimentView','comparisonView'].forEach(id => document.getElementById(id).classList.add('hidden'));
      document.getElementById(v).classList.remove('hidden');
      document.querySelector('.close-btn').classList.toggle('hidden', v === 'homeView');
      document.getElementById('fab').classList.toggle('hidden', v === 'homeView' || v === 'cameraView');
    }

    function goHome() {
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
      currentImageData = null;
      menuWines = [];
      showView('homeView');
    }

    function showAddOptions() { showView('addOptionsView'); }
    function showLearnOptions() { showView('learnOptionsView'); }
    function showDineOptions() { showView('dineOptionsView'); }

    async function startCamera(mode) {
      currentMode = mode || 'add';
      if (mode === 'learn') {
        document.getElementById('cameraTitle').textContent = 'Scan Wine Label';
        document.getElementById('cameraSubtitle').textContent = 'AI will identify the wine and provide details';
      } else if (mode === 'menu') {
        document.getElementById('cameraTitle').textContent = 'Scan Wine Menu';
        document.getElementById('cameraSubtitle').textContent = 'AI will extract all wines from the menu';
      } else {
        document.getElementById('cameraTitle').textContent = 'Take Photo';
        document.getElementById('cameraSubtitle').textContent = 'Center the label in the frame';
      }
      showView('cameraView');
      try {
        if (stream) stream.getTracks().forEach(t => t.stop());
        stream = await navigator.mediaDevices.getUserMedia({video: {facingMode}, audio: false});
        document.getElementById('video').srcObject = stream;
      } catch (err) {
        alert('Camera access denied');
        goHome();
      }
    }

    async function flipCamera() {
      facingMode = facingMode === 'environment' ? 'user' : 'environment';
      await startCamera(currentMode);
    }

    function capturePhoto() {
      const v = document.getElementById('video');
      const c = document.createElement('canvas');
      c.width = v.videoWidth;
      c.height = v.videoHeight;
      c.getContext('2d').drawImage(v, 0, 0);
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
      currentImageData = c.toDataURL('image/jpeg', 0.9);
      
      if (currentMode === 'learn') {
        extractWineNameAndLearn(currentImageData);
      } else if (currentMode === 'menu') {
        extractMenuWines(currentImageData);
      } else {
        processImage(currentImageData);
      }
    }

    function handleFileUpload(e) {
      const f = e.target.files[0];
      if (f) {
        const r = new FileReader();
        r.onload = e => { 
          currentImageData = e.target.result;
          processImage(e.target.result);
        };
        r.readAsDataURL(f);
      }
    }

    async function processImage(img) {
      showView('processingView');
      document.getElementById('processingStatus').textContent = 'Analyzing wine label...';
      
      const c = document.getElementById('imageContainer');
      c.innerHTML = `<img src="${img}" class="image-preview">`;
      
      const apiKey = localStorage.getItem('openai_key');
      if (apiKey) {
        try {
          const response = await fetch("https://api.openai.com/v1/chat/completions", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": "Bearer " + apiKey
            },
            body: JSON.stringify({
              model: "gpt-4o",
              messages: [{
                role: "user",
                content: [
                  { type: "image_url", image_url: { url: img } },
                  { 
                    type: "text", 
                    text: `Extract wine information from this label. Return ONLY JSON:
{
  "name": "wine name",
  "vintage": "year",
  "producer": "winery",
  "region": "region, country",
  "varietal": "grapes"
}`
                  }
                ]
              }],
              max_tokens: 500
            })
          });

          if (response.ok) {
            const data = await response.json();
            let text = data.choices[0].message.content.trim().replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            const wineData = JSON.parse(text);
            
            document.getElementById('wineName').value = wineData.name || '';
            document.getElementById('wineVintage').value = wineData.vintage || '';
            document.getElementById('wineProducer').value = wineData.producer || '';
            document.getElementById('wineRegion').value = wineData.region || '';
            document.getElementById('wineVarietal').value = wineData.varietal || '';
            
            showView('resultView');
            return;
          }
        } catch (err) {
          console.error('AI extraction failed:', err);
        }
      }
      
      document.getElementById('wineName').value = '';
      document.getElementById('wineVintage').value = '';
      document.getElementById('wineProducer').value = '';
      document.getElementById('wineRegion').value = '';
      document.getElementById('wineVarietal').value = '';
      showView('resultView');
    }

    function manualEntry() {
      currentImageData = null;
      const c = document.getElementById('imageContainer');
      c.innerHTML = '<div class="image-placeholder"><div class="icon">üç∑</div></div>';
      document.getElementById('wineName').value = '';
      document.getElementById('wineVintage').value = '';
      document.getElementById('wineProducer').value = '';
      document.getElementById('wineRegion').value = '';
      document.getElementById('wineVarietal').value = '';
      showView('resultView');
    }

    function saveWine() {
      const n = document.getElementById('wineName').value.trim();
      if (!n) { alert('Please enter a wine name'); return; }
      const w = {
        id: Date.now(),
        name: n,
        vintage: document.getElementById('wineVintage').value || '',
        producer: document.getElementById('wineProducer').value || '',
        region: document.getElementById('wineRegion').value || '',
        varietal: document.getElementById('wineVarietal').value || '',
        score: null,
        sentiment: null,
        comparisons: 0,
        notes: '',
        image: isValidImage(currentImageData) ? currentImageData : null,
        dateAdded: new Date().toISOString().split('T')[0]
      };
      wines.unshift(w);
      localStorage.setItem('wines', JSON.stringify(wines));
      updateCollectionCount();
      currentWineId = w.id;
      currentImageData = null;
      showSentimentPrompt();
    }

    async function extractWineNameAndLearn(imageData) {
      showView('processingView');
      document.getElementById('processingStatus').textContent = 'Reading wine label...';
      
      try {
        const apiKey = localStorage.getItem('openai_key');
        if (!apiKey) {
          alert('Please add your OpenAI API key in Settings to use AI wine recognition.');
          showSettings();
          return;
        }

        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + apiKey
          },
          body: JSON.stringify({
            model: "gpt-4o",
            messages: [{
              role: "user",
              content: [
                { type: "image_url", image_url: { url: imageData } },
                { 
                  type: "text", 
                  text: `Extract the wine name and vintage from this label. Return ONLY JSON:
{
  "name": "wine name",
  "vintage": "year"
}`
                }
              ]
            }],
            max_tokens: 200
          })
        });

        if (!response.ok) throw new Error('API request failed');

        const data = await response.json();
        let text = data.choices[0].message.content.trim().replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        const extracted = JSON.parse(text);
        
        const wineName = `${extracted.name} ${extracted.vintage}`.trim();
        await searchForWineDetails(wineName, imageData);
        
      } catch (err) {
        console.error('Extract error:', err);
        alert('Could not read wine label. Please try searching by name instead.');
        showLearnOptions();
      }
    }

    async function searchForWineDetails(wineName, imageData) {
      document.getElementById('processingStatus').textContent = 'Searching for wine details...';
      
      try {
        const apiKey = localStorage.getItem('openai_key');
        
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + apiKey
          },
          body: JSON.stringify({
            model: "gpt-4o",
            messages: [{
              role: "user",
              content: `Provide detailed information about the wine: "${wineName}". Return ONLY JSON:

{
  "name": "full wine name",
  "vintage": "year",
  "producer": "winery",
  "region": "region, country",
  "varietal": "grapes",
  "type": "Red/White/Ros√©/Sparkling/Dessert",
  "tastingNotes": "detailed tasting profile with flavors, aromas, body, tannins, acidity",
  "foodPairings": "specific dishes",
  "price": "price range",
  "description": "2-3 sentence overview"
}`
            }],
            max_tokens: 1500
          })
        });

        if (!response.ok) throw new Error('API request failed');

        const data = await response.json();
        let text = data.choices[0].message.content.trim().replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        
        learnedWineData = JSON.parse(text);
        learnedWineData.image = imageData;
        displayLearnedWine();

      } catch (err) {
        console.error('Search error:', err);
        alert('Could not find detailed information about this wine.');
        showLearnOptions();
      }
    }

    function searchWineManually() {
      showView('searchView');
    }

    async function searchWineByName() {
      const name = document.getElementById('searchWineName').value.trim();
      if (!name) {
        alert('Please enter a wine name');
        return;
      }
      await searchForWineDetails(name, null);
    }

    function displayLearnedWine() {
      const w = learnedWineData;
      const imgContainer = document.getElementById('learnImageContainer');
      
      if (w.image) {
        imgContainer.innerHTML = `<img src="${w.image}" class="image-preview">`;
      } else {
        imgContainer.innerHTML = '<div class="image-placeholder"><div class="icon">üç∑</div></div>';
      }

      document.getElementById('learnWineName').textContent = w.name || 'Unknown Wine';

      const typeColors = {
        'Red': '#dc2626',
        'White': '#fbbf24',
        'Ros√©': '#ec4899',
        'Sparkling': '#8b5cf6',
        'Dessert': '#f59e0b'
      };
      const typeColor = typeColors[w.type] || '#6b7280';

      document.getElementById('learnWineInfo').innerHTML = `
        ${w.type ? `<div style="margin-bottom: 16px;">
          <span class="type-badge" style="background: ${typeColor};">${w.type} Wine</span>
        </div>` : ''}

        ${w.description ? `<div class="form-group">
          <label>About This Wine</label>
          <div style="color: #374151; line-height: 1.6;">${w.description}</div>
        </div>` : ''}

        ${w.vintage ? `<div class="form-group">
          <label>Vintage</label>
          <div style="color: #6b7280">${w.vintage}</div>
        </div>` : ''}

        ${w.producer ? `<div class="form-group">
          <label>Producer</label>
          <div style="color: #6b7280">${w.producer}</div>
        </div>` : ''}

        ${w.region ? `<div class="form-group">
          <label>Region</label>
          <div style="color: #6b7280">${w.region}</div>
        </div>` : ''}

        ${w.varietal ? `<div class="form-group">
          <label>Varietal / Blend</label>
          <div style="color: #6b7280">${w.varietal}</div>
        </div>` : ''}

        ${w.tastingNotes ? `<div class="form-group">
          <label>Tasting Notes</label>
          <div style="color: #374151; line-height: 1.6; background: #f9fafb; padding: 12px; border-radius: 8px;">
            ${w.tastingNotes}
          </div>
        </div>` : ''}

        ${w.foodPairings ? `<div class="form-group">
          <label>Food Pairings</label>
          <div style="color: #374151; line-height: 1.6;">
            ${w.foodPairings}
          </div>
        </div>` : ''}

        ${w.price ? `<div class="form-group">
          <label>Typical Retail Price</label>
          <div style="color: #6b7280">${w.price}</div>
        </div>` : ''}

        ${w.menuPrice ? `<div class="form-group">
          <label>Menu Price</label>
          <div style="color: #722F37; font-weight: 600; font-size: 18px;">${w.menuPrice}</div>
          ${w.price ? `<div class="help-text">Compare to typical retail: ${w.price}</div>` : ''}
        </div>` : ''}
      `;

      showView('learnResultView');
    }

    function addLearnedWineToCollection() {
      if (!learnedWineData) return;
      
      const w = learnedWineData;
      const c = document.getElementById('imageContainer');
      c.innerHTML = w.image ? `<img src="${w.image}" class="image-preview">` : '<div class="image-placeholder"><div class="icon">üç∑</div></div>';
      
      document.getElementById('wineName').value = w.name || '';
      document.getElementById('wineVintage').value = w.vintage || '';
      document.getElementById('wineProducer').value = w.producer || '';
      document.getElementById('wineRegion').value = w.region || '';
      document.getElementById('wineVarietal').value = w.varietal || '';
      
      currentImageData = w.image;
      showView('resultView');
    }

    function showCollection() {
      const list = document.getElementById('wineList');
      const empty = document.getElementById('emptyState');
      if (wines.length === 0) {
        list.innerHTML = '';
        empty.classList.remove('hidden');
      } else {
        empty.classList.add('hidden');
        const sorted = [...wines].sort((a, b) => (b.score || 0) - (a.score || 0));
        list.innerHTML = sorted.map(w => `
          <div class="wine-item" onclick="showDetail(${w.id})">
            ${isValidImage(w.image) ? `<img src="${w.image}" class="wine-item-image">` : `<div class="wine-emoji">üç∑</div>`}
            <div class="wine-info">
              <div class="wine-name">${w.name}</div>
              <div class="wine-meta">${w.vintage ? w.vintage + ' ‚Ä¢ ' : ''}${w.region || w.producer || 'Unknown'}</div>
              <div class="rank-section">
                <span class="rank-badge ${!w.score ? 'unranked' : ''}">${w.score ? w.score.toFixed(1) : 'Unranked'}</span>
              </div>
            </div>
          </div>
        `).join('');
      }
      showView('collectionView');
    }

    function showDetail(id) {
      const w = wines.find(x => x.id === id);
      currentWineId = id;
      const sent = {'yes': 'üòç Loved It', 'ok': 'üòä It Was OK', 'no': 'üòê Didn\'t Like It'};
      document.getElementById('detailCard').innerHTML = `
        ${isValidImage(w.image) ? `<img src="${w.image}" class="image-preview">` : '<div class="image-placeholder"><div class="icon">üç∑</div></div>'}
        <h2>${w.name}</h2>
        <p class="subtitle">${w.vintage || 'Vintage not specified'}</p>
        ${w.producer ? `<div class="form-group"><label>Producer</label><div style="color: #6b7280">${w.producer}</div></div>` : ''}
        ${w.region ? `<div class="form-group"><label>Region</label><div style="color: #6b7280">${w.region}</div></div>` : ''}
        ${w.varietal ? `<div class="form-group"><label>Varietal</label><div style="color: #6b7280">${w.varietal}</div></div>` : ''}
        <div class="form-group">
          <label>Your Rating</label>
          <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
            <span class="rank-badge ${!w.score ? 'unranked' : ''}" style="font-size: 24px;">${w.score ? w.score.toFixed(1) : 'Not yet ranked'}</span>
            ${w.sentiment ? `<span style="font-size: 18px;">${sent[w.sentiment]}</span>` : ''}
          </div>
          ${w.score ? `<div class="help-text">Based on ${w.comparisons} comparison${w.comparisons !== 1 ? 's' : ''}</div>` : ''}
          <div style="margin-top: 12px;">
            <button class="btn btn-secondary" onclick="reRankWine(${id})" style="width: auto; padding: 8px 16px; font-size: 14px;">
              ${w.score ? 'Re-rank Wine' : 'Rank Wine'}
            </button>
          </div>
        </div>
        <div class="form-group">
          <label>Tasting Notes</label>
          <textarea id="wineNotes" placeholder="Add your tasting notes...">${w.notes}</textarea>
        </div>
        <div class="form-group">
          <label>Date Added</label>
          <div style="color: #6b7280">${w.dateAdded}</div>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="saveNotes()"><span>üíæ</span><span>Save Notes</span></button>
          <button class="btn btn-danger" onclick="deleteWine()">üóëÔ∏è Delete</button>
        </div>
      `;
      showView('detailView');
    }

    function saveNotes() {
      wines.find(w => w.id === currentWineId).notes = document.getElementById('wineNotes').value;
      localStorage.setItem('wines', JSON.stringify(wines));
      alert('Notes saved!');
    }

    function deleteWine() {
      if (confirm('Delete this wine?')) {
        wines = wines.filter(w => w.id !== currentWineId);
        localStorage.setItem('wines', JSON.stringify(wines));
        updateCollectionCount();
        showCollection();
      }
    }

    function updateCollectionCount() {
      document.getElementById('collectionCount').textContent = `My Collection (${wines.length})`;
      document.getElementById('wishlistCount').textContent = `Saved Wines (${wishlist.length})`;
    }

    function saveToWishlist() {
      if (!learnedWineData) return;
      
      // Check if already in wishlist
      const existing = wishlist.find(w => 
        w.name.toLowerCase() === learnedWineData.name.toLowerCase() && 
        w.vintage === learnedWineData.vintage
      );
      
      if (existing) {
        alert('This wine is already in your saved wines!');
        return;
      }
      
      const savedWine = {
        id: Date.now(),
        ...learnedWineData,
        savedDate: new Date().toISOString().split('T')[0]
      };
      
      wishlist.unshift(savedWine);
      localStorage.setItem('wishlist', JSON.stringify(wishlist));
      updateCollectionCount();
      alert('Wine saved! View it in "Saved Wines" from the home screen.');
    }

    function showWishlist() {
      const list = document.getElementById('wishlistList');
      const empty = document.getElementById('wishlistEmptyState');
      
      if (wishlist.length === 0) {
        list.innerHTML = '';
        empty.classList.remove('hidden');
      } else {
        empty.classList.add('hidden');
        list.innerHTML = wishlist.map(w => {
          const typeColors = {
            'Red': '#dc2626',
            'White': '#fbbf24',
            'Ros√©': '#ec4899',
            'Sparkling': '#8b5cf6',
            'Dessert': '#f59e0b'
          };
          const typeColor = typeColors[w.type] || '#6b7280';
          
          return `
          <div class="wine-item" onclick="showWishlistDetail(${w.id})">
            ${isValidImage(w.image) ? `<img src="${w.image}" class="wine-item-image">` : `<div class="wine-emoji">‚≠ê</div>`}
            <div class="wine-info">
              <div class="wine-name">${w.name}</div>
              <div class="wine-meta">${w.vintage ? w.vintage + ' ‚Ä¢ ' : ''}${w.region || w.producer || 'Unknown'}</div>
              <div class="rank-section">
                <span class="type-badge" style="background: ${typeColor}; padding: 2px 8px; font-size: 12px;">${w.type || 'Wine'}</span>
              </div>
            </div>
          </div>
        `}).join('');
      }
      
      showView('wishlistView');
    }

    function showWishlistDetail(id) {
      const w = wishlist.find(x => x.id === id);
      if (!w) return;
      
      const typeColors = {
        'Red': '#dc2626',
        'White': '#fbbf24',
        'Ros√©': '#ec4899',
        'Sparkling': '#8b5cf6',
        'Dessert': '#f59e0b'
      };
      const typeColor = typeColors[w.type] || '#6b7280';
      
      document.getElementById('wishlistDetailCard').innerHTML = `
        ${isValidImage(w.image) ? `<img src="${w.image}" class="image-preview">` : '<div class="image-placeholder"><div class="icon">‚≠ê</div></div>'}
        <h2>${w.name}</h2>
        <p class="subtitle">${w.vintage || 'Vintage not specified'}</p>
        
        ${w.type ? `<div style="margin-bottom: 16px;">
          <span class="type-badge" style="background: ${typeColor};">${w.type} Wine</span>
        </div>` : ''}

        ${w.description ? `<div class="form-group">
          <label>About This Wine</label>
          <div style="color: #374151; line-height: 1.6;">${w.description}</div>
        </div>` : ''}

        ${w.producer ? `<div class="form-group">
          <label>Producer</label>
          <div style="color: #6b7280">${w.producer}</div>
        </div>` : ''}

        ${w.region ? `<div class="form-group">
          <label>Region</label>
          <div style="color: #6b7280">${w.region}</div>
        </div>` : ''}

        ${w.varietal ? `<div class="form-group">
          <label>Varietal / Blend</label>
          <div style="color: #6b7280">${w.varietal}</div>
        </div>` : ''}

        ${w.tastingNotes ? `<div class="form-group">
          <label>Tasting Notes</label>
          <div style="color: #374151; line-height: 1.6; background: #f9fafb; padding: 12px; border-radius: 8px;">
            ${w.tastingNotes}
          </div>
        </div>` : ''}

        ${w.foodPairings ? `<div class="form-group">
          <label>Food Pairings</label>
          <div style="color: #374151; line-height: 1.6;">
            ${w.foodPairings}
          </div>
        </div>` : ''}

        ${w.price ? `<div class="form-group">
          <label>Typical Price</label>
          <div style="color: #6b7280">${w.price}</div>
        </div>` : ''}

        <div class="form-group">
          <label>Saved Date</label>
          <div style="color: #6b7280">${w.savedDate}</div>
        </div>

        <div class="btn-group">
          <button class="btn btn-primary" onclick="addWishlistToCollection(${id})">
            <span>‚ûï</span><span>Add to Collection</span>
          </button>
          <button class="btn btn-danger" onclick="deleteFromWishlist(${id})">
            üóëÔ∏è Remove
          </button>
        </div>
      `;
      
      showView('wishlistDetailView');
    }

    function addWishlistToCollection(id) {
      const w = wishlist.find(x => x.id === id);
      if (!w) return;
      
      const c = document.getElementById('imageContainer');
      c.innerHTML = w.image ? `<img src="${w.image}" class="image-preview">` : '<div class="image-placeholder"><div class="icon">üç∑</div></div>';
      
      document.getElementById('wineName').value = w.name || '';
      document.getElementById('wineVintage').value = w.vintage || '';
      document.getElementById('wineProducer').value = w.producer || '';
      document.getElementById('wineRegion').value = w.region || '';
      document.getElementById('wineVarietal').value = w.varietal || '';
      
      currentImageData = w.image;
      showView('resultView');
    }

    function deleteFromWishlist(id) {
      if (confirm('Remove this wine from saved wines?')) {
        wishlist = wishlist.filter(w => w.id !== id);
        localStorage.setItem('wishlist', JSON.stringify(wishlist));
        updateCollectionCount();
        showWishlist();
      }
    }

    async function extractMenuWines(imageData) {
      showView('processingView');
      document.getElementById('processingStatus').textContent = 'Reading menu...';
      
      try {
        const apiKey = localStorage.getItem('openai_key');
        if (!apiKey) {
          alert('Please add your OpenAI API key in Settings to use AI menu scanning.');
          showSettings();
          return;
        }

        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + apiKey
          },
          body: JSON.stringify({
            model: "gpt-4o",
            messages: [{
              role: "user",
              content: [
                { type: "image_url", image_url: { url: imageData } },
                { 
                  type: "text", 
                  text: `Extract ALL wines from this restaurant wine menu/list. Return ONLY a JSON array:

[
  {
    "name": "wine name",
    "vintage": "year",
    "producer": "producer if shown",
    "price": "price including $ sign",
    "glassPrice": "by-glass price if shown",
    "bottlePrice": "bottle price if shown"
  }
]

Extract every wine you can see. If vintage/producer not shown, use empty string. Be thorough.`
                }
              ]
            }],
            max_tokens: 2000
          })
        });

        if (!response.ok) throw new Error('API request failed');

        const data = await response.json();
        let text = data.choices[0].message.content.trim().replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        
        menuWines = JSON.parse(text);
        
        if (!menuWines || menuWines.length === 0) {
          alert('No wines found on this menu. Please try again with a clearer photo.');
          showDineOptions();
          return;
        }
        
        displayMenuWines();
        
      } catch (err) {
        console.error('Menu extract error:', err);
        alert('Could not read menu. Please ensure the photo is clear and try again.');
        showDineOptions();
      }
    }

    function displayMenuWines() {
      const list = document.getElementById('menuWineList');
      
      list.innerHTML = menuWines.map((w, index) => {
        const displayPrice = w.price || w.bottlePrice || w.glassPrice || 'Price not listed';
        
        return `
          <div class="wine-item" onclick="learnAboutMenuWine(${index})">
            <div class="wine-emoji">üçΩÔ∏è</div>
            <div class="wine-info">
              <div class="wine-name">${w.name}</div>
              <div class="wine-meta">
                ${w.vintage ? w.vintage : 'Vintage N/A'}
                ${w.producer ? ' ‚Ä¢ ' + w.producer : ''}
              </div>
              <div class="wine-meta" style="color: #722F37; font-weight: 600; margin-top: 4px;">
                ${displayPrice}
                ${w.glassPrice && w.bottlePrice ? ' (Glass: ' + w.glassPrice + ' / Bottle: ' + w.bottlePrice + ')' : ''}
              </div>
            </div>
          </div>
        `}).join('');
      
      showView('menuResultView');
    }

    async function learnAboutMenuWine(index) {
      const w = menuWines[index];
      const wineName = `${w.name} ${w.vintage}`.trim();
      
      // Store the menu price for reference
      const menuPrice = w.price || w.bottlePrice || w.glassPrice || null;
      
      await searchForWineDetails(wineName, null, menuPrice);
    }

    async function searchForWineDetails(wineName, imageData, menuPrice) {
      if (!menuPrice) {
        document.getElementById('processingStatus').textContent = 'Searching for wine details...';
      } else {
        showView('processingView');
        document.getElementById('processingStatus').textContent = 'Getting wine details...';
      }
      
      try {
        const apiKey = localStorage.getItem('openai_key');
        
        const response = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + apiKey
          },
          body: JSON.stringify({
            model: "gpt-4o",
            messages: [{
              role: "user",
              content: `Provide detailed information about the wine: "${wineName}". Return ONLY JSON:

{
  "name": "full wine name",
  "vintage": "year",
  "producer": "winery",
  "region": "region, country",
  "varietal": "grapes",
  "type": "Red/White/Ros√©/Sparkling/Dessert",
  "tastingNotes": "detailed tasting profile with flavors, aromas, body, tannins, acidity",
  "foodPairings": "specific dishes",
  "price": "typical retail price range",
  "description": "2-3 sentence overview"
}`
            }],
            max_tokens: 1500
          })
        });

        if (!response.ok) throw new Error('API request failed');

        const data = await response.json();
        let text = data.choices[0].message.content.trim().replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
        
        learnedWineData = JSON.parse(text);
        learnedWineData.image = imageData;
        learnedWineData.menuPrice = menuPrice; // Store menu price if from menu scan
        displayLearnedWine();

      } catch (err) {
        console.error('Search error:', err);
        alert('Could not find detailed information about this wine.');
        if (menuWines.length > 0) {
          displayMenuWines();
        } else {
          showLearnOptions();
        }
      }
    }

    function showSettings() {
      document.getElementById('apiKeyInput').value = localStorage.getItem('openai_key') || '';
      showView('settingsView');
    }

    function saveSettings() {
      const k = document.getElementById('apiKeyInput').value.trim();
      if (k) {
        localStorage.setItem('openai_key', k);
        alert('API key saved!');
      } else {
        localStorage.removeItem('openai_key');
        alert('API key removed.');
      }
      goHome();
    }

    function showSentimentPrompt() {
      const w = wines.find(x => x.id === currentWineId);
      document.getElementById('sentimentWineName').textContent = w.name;
      showView('sentimentView');
    }

    function setSentiment(s) {
      wines.find(w => w.id === currentWineId).sentiment = s;
      localStorage.setItem('wines', JSON.stringify(wines));
      startComparisonRanking(s);
    }

    function skipRanking() {
      if (confirm('Skip ranking? You can rank later from detail page.')) showCollection();
    }

    function reRankWine(id) {
      currentWineId = id;
      showSentimentPrompt();
    }

    function startComparisonRanking(s) {
      const w = wines.find(x => x.id === currentWineId);
      const same = wines.filter(x => x.sentiment === s && x.id !== currentWineId && x.score !== null);
      
      if (same.length === 0) {
        w.score = s === 'yes' ? 8.5 : s === 'ok' ? 5.5 : 2.5;
        w.comparisons = 0;
        recalculateAllScores();
        localStorage.setItem('wines', JSON.stringify(wines));
        showCollection();
        return;
      }
      
      const sorted = same.sort((a, b) => b.score - a.score);
      currentComparison = {
        newWine: w,
        sentiment: s,
        sortedWines: sorted,
        low: 0,
        high: sorted.length - 1,
        comparisonCount: 0
      };
      
      compareNextBinary();
    }

    function compareNextBinary() {
      const {newWine, sortedWines, low, high} = currentComparison;
      
      if (low > high) {
        finalizeBinaryRanking();
        return;
      }
      
      const mid = Math.floor((low + high) / 2);
      currentComparison.currentMid = mid;
      currentComparison.opponent = sortedWines[mid];
      currentComparison.comparisonCount++;
      
      displayComparison();
    }

    function displayComparison() {
      showView('comparisonView');
      const {newWine, opponent} = currentComparison;
      document.getElementById('comparisonOptions').innerHTML = `
        <div class="wine-comparison-card" onclick="selectWinner('new')">
          ${isValidImage(newWine.image) ? `<img src="${newWine.image}">` : '<div class="wine-icon-large">üç∑</div>'}
          <h3>${newWine.name}</h3>
          <p class="vintage">${newWine.vintage || 'N/A'}</p>
        </div>
        <div class="wine-comparison-card" onclick="selectWinner('opponent')">
          ${isValidImage(opponent.image) ? `<img src="${opponent.image}">` : '<div class="wine-icon-large">üç∑</div>'}
          <h3>${opponent.name}</h3>
          <p class="vintage">${opponent.vintage || 'N/A'}${opponent.score ? ' ‚Ä¢ ' + opponent.score.toFixed(1) : ''}</p>
        </div>
      `;
    }

    function selectWinner(winner) {
      const {sortedWines, currentMid, low, high} = currentComparison;
      
      if (winner === 'new') {
        currentComparison.high = currentMid - 1;
      } else {
        currentComparison.low = currentMid + 1;
      }
      
      compareNextBinary();
    }

    function finalizeBinaryRanking() {
      const {newWine, sentiment, sortedWines, low, comparisonCount} = currentComparison;
      
      const maxScore = sentiment === 'yes' ? 10.0 : sentiment === 'ok' ? 7.0 : 4.0;
      const minScore = sentiment === 'yes' ? 7.0 : sentiment === 'ok' ? 4.1 : 1.0;
      
      let score;
      if (sortedWines.length === 0) {
        score = (maxScore + minScore) / 2;
      } else if (low === 0) {
        score = maxScore;
      } else if (low >= sortedWines.length) {
        score = minScore;
      } else {
        const above = sortedWines[low - 1].score;
        const below = sortedWines[low].score;
        score = (above + below) / 2 + (Math.random() * 0.01 - 0.005);
      }
      
      newWine.score = Math.max(minScore, Math.min(maxScore, score));
      newWine.comparisons = comparisonCount;
      
      recalculateAllScores();
      localStorage.setItem('wines', JSON.stringify(wines));
      finishRanking();
    }

    function recalculateAllScores() {
      ['yes', 'ok', 'no'].forEach(s => {
        const sw = wines.filter(w => w.sentiment === s && w.score !== null).sort((a, b) => b.score - a.score);
        if (sw.length === 0) return;
        
        const max = s === 'yes' ? 10.0 : s === 'ok' ? 7.0 : 4.0;
        const min = s === 'yes' ? 7.0 : s === 'ok' ? 4.1 : 1.0;
        
        if (sw.length === 1) {
          sw[0].score = max;
        } else {
          const step = (max - min) / (sw.length - 1);
          sw.forEach((w, i) => {
            w.score = max - (i * step);
          });
        }
      });
    }

    function finishRanking() {
      const w = wines.find(x => x.id === currentWineId);
      if (w.score !== null) alert(`Ranked! Your wine scored ${w.score.toFixed(1)}/10`);
      showCollection();
    }

    updateCollectionCount();
  </script>
</body>
</html>
