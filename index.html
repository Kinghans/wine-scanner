<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#9333ea">
  <title>WineScan - Wine Collection Tracker</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
      background: linear-gradient(135deg, #faf5ff 0%, #fce7f3 100%);
      min-height: 100vh;
      padding-bottom: 20px;
    }

    .container {
      max-width: 500px;
      margin: 0 auto;
    }

    .header {
      background: linear-gradient(135deg, #9333ea 0%, #ec4899 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .header h1 {
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s;
      width: 100%;
    }

    .btn-primary {
      background: linear-gradient(135deg, #9333ea 0%, #ec4899 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(147, 51, 234, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 16px rgba(147, 51, 234, 0.4);
    }

    .btn-secondary {
      background: white;
      color: #9333ea;
      border: 2px solid #9333ea;
    }

    .btn-secondary:hover {
      background: #faf5ff;
    }

    .content {
      padding: 20px;
    }

    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }

    .wine-icon {
      font-size: 64px;
      text-align: center;
      margin-bottom: 20px;
    }

    .text-center {
      text-align: center;
    }

    h2 {
      font-size: 24px;
      margin-bottom: 8px;
      color: #1f2937;
    }

    .subtitle {
      color: #6b7280;
      margin-bottom: 24px;
    }

    .wine-list {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .wine-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      gap: 16px;
      align-items: center;
    }

    .wine-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.12);
    }

    .wine-emoji {
      font-size: 40px;
    }

    .wine-info {
      flex: 1;
    }

    .wine-name {
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 4px;
    }

    .wine-meta {
      font-size: 14px;
      color: #6b7280;
    }

    .rank-section {
      display: flex;
      gap: 4px;
      margin-top: 4px;
      align-items: center;
    }

    .rank-badge {
      background: linear-gradient(135deg, #9333ea 0%, #ec4899 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
      display: inline-block;
    }

    .rank-badge.unranked {
      background: #e5e7eb;
      color: #6b7280;
    }

    .hidden {
      display: none !important;
    }

    .camera-container {
      position: relative;
      width: 100%;
      height: 500px;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 16px;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .camera-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 3px dashed rgba(255, 255, 255, 0.8);
      width: 70%;
      height: 75%;
      border-radius: 12px;
      pointer-events: none;
    }

    .camera-hint {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
      max-width: 80%;
      z-index: 10;
    }

    .camera-controls {
      position: absolute;
      bottom: 20px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      z-index: 10;
    }

    .capture-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: white;
      border: 4px solid #9333ea;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }

    .capture-btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #9333ea;
    }

    .capture-btn:active {
      transform: scale(0.9);
    }

    .flip-camera-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    canvas {
      max-width: 100%;
      border-radius: 12px;
    }

    .processing {
      text-align: center;
      padding: 40px 20px;
    }

    .spinner {
      border: 4px solid #f3f4f6;
      border-top: 4px solid #9333ea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .form-group {
      margin-bottom: 16px;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
      font-size: 14px;
    }

    input, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      font-family: inherit;
    }

    input:focus, textarea:focus {
      outline: none;
      border-color: #9333ea;
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .btn-group {
      display: flex;
      gap: 12px;
      margin-top: 24px;
    }

    .btn-danger {
      background: #fee;
      color: #dc2626;
      border: none;
    }

    .btn-danger:hover {
      background: #fdd;
    }

    .close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 28px;
      cursor: pointer;
      padding: 0;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .close-btn:hover {
      background: rgba(255,255,255,0.2);
    }

    .settings-btn {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s;
    }

    .settings-btn:hover {
      background: rgba(255,255,255,0.2);
    }

    .image-preview {
      width: 100%;
      border-radius: 12px;
      margin-bottom: 16px;
    }

    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #9333ea 0%, #ec4899 100%);
      color: white;
      border: none;
      font-size: 32px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(147, 51, 234, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }

    .fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 16px rgba(147, 51, 234, 0.5);
    }

    .file-input {
      display: none;
    }

    .option-buttons {
      display: flex;
      gap: 12px;
      flex-direction: column;
    }

    .help-text {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }

    .skip-scan {
      margin-top: 12px;
      text-align: center;
    }

    .skip-scan button {
      background: none;
      border: none;
      color: #9333ea;
      text-decoration: underline;
      cursor: pointer;
      font-size: 14px;
    }

    .comparison-view {
      max-width: 100%;
    }

    .comparison-options {
      display: flex;
      gap: 12px;
      margin-bottom: 24px;
    }

    .wine-comparison-card {
      flex: 1;
      background: white;
      border: 3px solid #e5e7eb;
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }

    .wine-comparison-card:hover {
      transform: translateY(-4px);
      border-color: #9333ea;
      box-shadow: 0 8px 20px rgba(147, 51, 234, 0.2);
    }

    .wine-comparison-card:active {
      transform: scale(0.98);
    }

    .wine-comparison-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 12px;
    }

    .wine-comparison-card h3 {
      font-size: 16px;
      margin-bottom: 4px;
      color: #1f2937;
    }

    .wine-comparison-card .vintage {
      font-size: 14px;
      color: #6b7280;
    }

    .comparison-prompt {
      text-align: center;
      margin-bottom: 24px;
      color: #6b7280;
      font-size: 18px;
      font-weight: 500;
    }

    .comparison-controls {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 24px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-content">
        <h1>
          <span>üç∑</span>
          <span>WineScan</span>
        </h1>
        <div style="display: flex; gap: 8px;">
          <button class="settings-btn" onclick="showSettings()" title="Settings">‚öôÔ∏è</button>
          <button class="close-btn hidden" onclick="goHome()">√ó</button>
        </div>
      </div>
    </div>

    <!-- Home View -->
    <div id="homeView" class="content">
      <div class="card text-center">
        <div class="wine-icon">üç∑</div>
        <h2>Discover & Track Wines</h2>
        <p class="subtitle">Scan labels, save favorites, build your collection</p>
        
        <div class="option-buttons">
          <button class="btn btn-primary" onclick="startCamera()">
            <span>üì∑</span>
            <span>Take Photo</span>
          </button>
          
          <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
            <span>üñºÔ∏è</span>
            <span>Upload from Library</span>
          </button>
          
          <button class="btn btn-secondary" onclick="manualEntry()">
            <span>‚úçÔ∏è</span>
            <span>Enter Manually</span>
          </button>
        </div>
        
        <input type="file" id="fileInput" class="file-input" accept="image/*" onchange="handleFileUpload(event)">
        
        <div style="height: 24px"></div>
        <button class="btn btn-secondary" onclick="showCollection()">
          <span>üç∑</span>
          <span id="collectionCount">My Collection (0)</span>
        </button>
      </div>
    </div>

    <!-- Camera View -->
    <div id="cameraView" class="content hidden">
      <div class="card">
        <h2>Scan Wine Label</h2>
        <p class="subtitle">Center the label in the frame</p>
        <div class="camera-container">
          <video id="video" autoplay playsinline></video>
          <div class="camera-overlay"></div>
          <div class="camera-hint">Position label vertically in frame</div>
          <div class="camera-controls">
            <button class="flip-camera-btn" onclick="flipCamera()">üîÑ</button>
            <button class="capture-btn" onclick="capturePhoto()"></button>
          </div>
        </div>
        <div class="skip-scan">
          <button onclick="manualEntry()">Skip scan and enter manually</button>
        </div>
        <div style="height: 12px"></div>
        <button class="btn btn-secondary" onclick="goHome()">Cancel</button>
      </div>
    </div>

    <!-- Processing View -->
    <div id="processingView" class="content hidden">
      <div class="card processing">
        <div class="spinner"></div>
        <h2>Processing...</h2>
        <p class="subtitle" id="processingStatus">Extracting wine information</p>
      </div>
    </div>

    <!-- Result View -->
    <div id="resultView" class="content hidden">
      <div class="card">
        <img id="capturedImage" class="image-preview" alt="Wine label">
        <h2>Wine Details</h2>
        <p class="subtitle">Edit any fields as needed</p>
        
        <div class="form-group">
          <label>Wine Name *</label>
          <input type="text" id="wineName" placeholder="e.g., Ch√¢teau Margaux">
          <div class="help-text">Required field</div>
        </div>
        
        <div class="form-group">
          <label>Vintage Year</label>
          <input type="number" id="wineVintage" placeholder="e.g., 2018" min="1900" max="2025">
        </div>
        
        <div class="form-group">
          <label>Producer / Winery</label>
          <input type="text" id="wineProducer" placeholder="e.g., Ch√¢teau Margaux">
        </div>
        
        <div class="form-group">
          <label>Region / Appellation</label>
          <input type="text" id="wineRegion" placeholder="e.g., Bordeaux, France">
        </div>
        
        <div class="form-group">
          <label>Varietal / Blend</label>
          <input type="text" id="wineVarietal" placeholder="e.g., Cabernet Sauvignon">
        </div>
        
        <div class="btn-group">
          <button class="btn btn-primary" onclick="saveWine()" style="flex: 2">
            <span>üíæ</span>
            <span>Save to Collection</span>
          </button>
          <button class="btn btn-secondary" onclick="goHome()" style="flex: 1">
            Cancel
          </button>
        </div>
      </div>
    </div>

    <!-- Collection View -->
    <div id="collectionView" class="content hidden">
      <h2 style="margin-bottom: 16px; color: #1f2937;">My Wines</h2>
      <div id="wineList" class="wine-list"></div>
      <div id="emptyState" class="card text-center hidden">
        <div class="wine-icon">üç∑</div>
        <h2>No wines yet</h2>
        <p class="subtitle">Start scanning to build your collection!</p>
      </div>
    </div>

    <!-- Detail View -->
    <div id="detailView" class="content hidden">
      <div class="card" id="detailCard"></div>
    </div>

    <!-- Settings View -->
    <div id="settingsView" class="content hidden">
      <div class="card">
        <h2>Settings</h2>
        <p class="subtitle">Configure AI wine recognition</p>
        
        <div class="form-group">
          <label>OpenAI API Key</label>
          <input type="password" id="apiKeyInput" placeholder="sk-...">
          <div class="help-text">Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #9333ea;">platform.openai.com</a></div>
          <div class="help-text" style="margin-top: 8px;">This enables AI-powered wine label recognition. Your key is stored locally on your device.</div>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-primary" onclick="saveSettings()">
            <span>üíæ</span>
            <span>Save API Key</span>
          </button>
          <button class="btn btn-secondary" onclick="goHome()">
            Cancel
          </button>
        </div>
        
        <div style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #f3f4f6;">
          <h3 style="font-size: 16px; margin-bottom: 8px;">How to get an API key:</h3>
          <ol style="color: #6b7280; font-size: 14px; line-height: 1.6; margin-left: 20px;">
            <li>Visit <a href="https://platform.openai.com/signup" target="_blank" style="color: #9333ea;">platform.openai.com/signup</a></li>
            <li>Create an account or sign in</li>
            <li>Go to API Keys section</li>
            <li>Click "Create new secret key"</li>
            <li>Copy and paste it above</li>
          </ol>
          <div class="help-text" style="margin-top: 12px;">Note: OpenAI charges per API call (~$0.01 per wine scan). You'll need to add payment info.</div>
        </div>
      </div>
    </div>

    <!-- Comparison View -->
    <div id="comparisonView" class="content hidden">
      <div class="card comparison-view">
        <h2>Rank Your Wines</h2>
        <p class="comparison-prompt">Which wine did you prefer?</p>
        
        <div class="comparison-options" id="comparisonOptions"></div>
        
        <div class="comparison-controls">
          <button class="btn btn-secondary" onclick="skipComparison()">
            Can't Decide / Skip
          </button>
        </div>
        
        <div style="margin-top: 24px; padding-top: 24px; border-top: 2px solid #f3f4f6; text-align: center;">
          <p style="color: #6b7280; font-size: 14px;">
            Compare wines to build your personal ranking.<br>
            The more you compare, the more accurate your rankings become!
          </p>
        </div>
      </div>
    </div>

    <!-- Floating Action Button -->
    <button class="fab hidden" id="fab" onclick="startCamera()">üì∑</button>
  </div>

  <script>
    let wines = JSON.parse(localStorage.getItem('wines') || '[]');
    let currentWineId = null;
    let stream = null;
    let facingMode = 'environment';
    let currentComparison = null;

    // Migrate old wines to new format
    wines = wines.map(w => ({
      ...w,
      eloScore: w.eloScore || 1500,
      comparisons: w.comparisons || 0,
      rating: null
    }));

    function showView(viewId) {
      ['homeView', 'cameraView', 'processingView', 'resultView', 'collectionView', 'detailView', 'settingsView', 'comparisonView'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
      });
      document.getElementById(viewId).classList.remove('hidden');
      
      document.querySelector('.close-btn').classList.toggle('hidden', viewId === 'homeView');
      document.getElementById('fab').classList.toggle('hidden', viewId === 'homeView' || viewId === 'cameraView');
    }

    function goHome() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }
      showView('homeView');
    }

    async function startCamera() {
      showView('cameraView');
      try {
        if (stream) {
          stream.getTracks().forEach(track => track.stop());
        }
        stream = await navigator.mediaDevices.getUserMedia({ 
          video: { facingMode: facingMode },
          audio: false 
        });
        document.getElementById('video').srcObject = stream;
      } catch (err) {
        alert('Camera access denied. Please enable camera permissions in your browser settings.');
        goHome();
      }
    }

    async function flipCamera() {
      facingMode = facingMode === 'environment' ? 'user' : 'environment';
      await startCamera();
    }

    function capturePhoto() {
      const video = document.getElementById('video');
      const canvas = document.createElement('canvas');
      canvas.width = video.videoWidth;
      canvas.height = video.videoHeight;
      const ctx = canvas.getContext('2d');
      ctx.drawImage(video, 0, 0);
      
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
      }

      const imageData = canvas.toDataURL('image/jpeg', 0.9);
      processImage(imageData);
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          processImage(e.target.result);
        };
        reader.readAsDataURL(file);
      }
    }

    async function processImage(imageData) {
      showView('processingView');
      document.getElementById('processingStatus').textContent = 'Analyzing wine label with AI...';
      
      try {
        // Try OpenAI GPT-4 Vision
        const openaiResponse = await fetch("https://api.openai.com/v1/chat/completions", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": "Bearer " + (localStorage.getItem('openai_key') || '')
          },
          body: JSON.stringify({
            model: "gpt-4o",
            messages: [
              {
                role: "user",
                content: [
                  {
                    type: "image_url",
                    image_url: {
                      url: imageData
                    }
                  },
                  {
                    type: "text",
                    text: `Analyze this wine label and extract the following information. Return ONLY a JSON object with these fields (use empty strings if information is not visible):

{
  "name": "full wine name",
  "vintage": "year only (e.g., 2018)",
  "producer": "winery or ch√¢teau name",
  "region": "region and country (e.g., Bordeaux, France)",
  "varietal": "grape variety or blend type"
}

Be precise and only include information you can clearly see on the label.`
                  }
                ]
              }
            ],
            max_tokens: 500
          })
        });

        if (openaiResponse.ok) {
          const data = await openaiResponse.json();
          
          if (data.choices && data.choices[0] && data.choices[0].message) {
            let responseText = data.choices[0].message.content.trim();
            
            // Remove markdown code fences if present
            responseText = responseText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            
            const wineData = JSON.parse(responseText);
            
            document.getElementById('capturedImage').src = imageData;
            document.getElementById('wineName').value = wineData.name || '';
            document.getElementById('wineVintage').value = wineData.vintage || '';
            document.getElementById('wineProducer').value = wineData.producer || '';
            document.getElementById('wineRegion').value = wineData.region || '';
            document.getElementById('wineVarietal').value = wineData.varietal || '';
            
            showView('resultView');
            
            if (!wineData.name && !wineData.vintage) {
              alert('Could not identify wine details. Please enter manually.');
            }
            return;
          }
        }
        
        // If OpenAI fails, check if API key is missing
        if (openaiResponse.status === 401) {
          const apiKey = prompt('OpenAI API key required. Enter your API key (get one at platform.openai.com):');
          if (apiKey) {
            localStorage.setItem('openai_key', apiKey);
            // Retry with the new key
            processImage(imageData);
            return;
          }
        }
        
        throw new Error('AI analysis failed');
        
      } catch (err) {
        console.error('AI Analysis Error:', err);
        
        // Fallback: Just show the form with the image
        document.getElementById('capturedImage').src = imageData;
        document.getElementById('wineName').value = '';
        document.getElementById('wineVintage').value = '';
        document.getElementById('wineProducer').value = '';
        document.getElementById('wineRegion').value = '';
        document.getElementById('wineVarietal').value = '';
        
        showView('resultView');
        alert('AI analysis not available. Please enter wine details manually.');
      }
    }

    function manualEntry() {
      document.getElementById('capturedImage').src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="400" height="300"><rect fill="%239333ea" width="400" height="300"/><text x="50%" y="50%" fill="white" font-size="48" text-anchor="middle" dy=".3em">üç∑</text></svg>';
      document.getElementById('wineName').value = '';
      document.getElementById('wineVintage').value = '';
      document.getElementById('wineProducer').value = '';
      document.getElementById('wineRegion').value = '';
      document.getElementById('wineVarietal').value = '';
      showView('resultView');
    }

    function saveWine() {
      const name = document.getElementById('wineName').value.trim();
      
      if (!name) {
        alert('Please enter a wine name');
        document.getElementById('wineName').focus();
        return;
      }
      
      const wine = {
        id: Date.now(),
        name: name,
        vintage: document.getElementById('wineVintage').value || '',
        producer: document.getElementById('wineProducer').value || '',
        region: document.getElementById('wineRegion').value || '',
        varietal: document.getElementById('wineVarietal').value || '',
        rating: null,
        eloScore: 1500,
        comparisons: 0,
        notes: '',
        image: document.getElementById('capturedImage').src,
        dateAdded: new Date().toISOString().split('T')[0]
      };
      
      wines.unshift(wine);
      localStorage.setItem('wines', JSON.stringify(wines));
      updateCollectionCount();
      
      // Prompt to rank if we have 2+ wines
      if (wines.length >= 2) {
        if (confirm('Wine saved! Would you like to rank it against your other wines?')) {
          startComparison();
        } else {
          showCollection();
        }
      } else {
        showCollection();
      }
    }

    function showCollection() {
      const list = document.getElementById('wineList');
      const empty = document.getElementById('emptyState');
      
      if (wines.length === 0) {
        list.innerHTML = '';
        empty.classList.remove('hidden');
      } else {
        empty.classList.add('hidden');
        
        // Sort by ELO score
        const sortedWines = [...wines].sort((a, b) => b.eloScore - a.eloScore);
        
        list.innerHTML = sortedWines.map((wine, index) => {
          const rank = index + 1;
          const hasRanking = wine.comparisons > 0;
          
          return `
          <div class="wine-item" onclick="showDetail(${wine.id})">
            <div class="wine-emoji">üç∑</div>
            <div class="wine-info">
              <div class="wine-name">${wine.name}</div>
              <div class="wine-meta">
                ${wine.vintage ? wine.vintage + ' ‚Ä¢ ' : ''}${wine.region || wine.producer || 'Unknown region'}
              </div>
              <div class="rank-section">
                <span class="rank-badge ${!hasRanking ? 'unranked' : ''}">${hasRanking ? `#${rank} of ${wines.length}` : 'Unranked'}</span>
              </div>
            </div>
          </div>
        `}).join('');
      }
      
      showView('collectionView');
    }

    function showDetail(id) {
      const wine = wines.find(w => w.id === id);
      currentWineId = id;
      
      // Calculate rank
      const sortedWines = [...wines].sort((a, b) => b.eloScore - a.eloScore);
      const rank = sortedWines.findIndex(w => w.id === id) + 1;
      const hasRanking = wine.comparisons > 0;
      
      const card = document.getElementById('detailCard');
      card.innerHTML = `
        <img src="${wine.image}" class="image-preview" alt="Wine label">
        <h2>${wine.name}</h2>
        <p class="subtitle">${wine.vintage || 'Vintage not specified'}</p>
        
        ${wine.producer ? `<div class="form-group">
          <label>Producer</label>
          <div style="color: #6b7280">${wine.producer}</div>
        </div>` : ''}
        
        ${wine.region ? `<div class="form-group">
          <label>Region</label>
          <div style="color: #6b7280">${wine.region}</div>
        </div>` : ''}
        
        ${wine.varietal ? `<div class="form-group">
          <label>Varietal</label>
          <div style="color: #6b7280">${wine.varietal}</div>
        </div>` : ''}
        
        <div class="form-group">
          <label>Your Ranking</label>
          <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
            <span class="rank-badge ${!hasRanking ? 'unranked' : ''}" style="font-size: 18px;">
              ${hasRanking ? `#${rank} of ${wines.length}` : 'Not yet ranked'}
            </span>
            ${wines.length >= 2 ? `<button class="btn btn-secondary" onclick="startComparisonForWine(${id})" style="width: auto; padding: 8px 16px; font-size: 14px;">
              Compare Now
            </button>` : ''}
          </div>
          ${hasRanking ? `<div class="help-text">Based on ${wine.comparisons} comparison${wine.comparisons !== 1 ? 's' : ''}</div>` : ''}
        </div>
        
        <div class="form-group">
          <label>Tasting Notes</label>
          <textarea id="wineNotes" placeholder="Add your tasting notes, food pairings, or memories...">${wine.notes}</textarea>
        </div>
        
        <div class="form-group">
          <label>Date Added</label>
          <div style="color: #6b7280">${wine.dateAdded}</div>
        </div>
        
        <div class="btn-group">
          <button class="btn btn-primary" onclick="saveNotes()">
            <span>üíæ</span>
            <span>Save Notes</span>
          </button>
          <button class="btn btn-danger" onclick="deleteWine()">
            üóëÔ∏è Delete
          </button>
        </div>
      `;
      
      showView('detailView');
    }

    function saveNotes() {
      const wine = wines.find(w => w.id === currentWineId);
      wine.notes = document.getElementById('wineNotes').value;
      localStorage.setItem('wines', JSON.stringify(wines));
      alert('Notes saved!');
    }

    function deleteWine() {
      if (confirm('Delete this wine from your collection?')) {
        wines = wines.filter(w => w.id !== currentWineId);
        localStorage.setItem('wines', JSON.stringify(wines));
        updateCollectionCount();
        showCollection();
      }
    }

    function updateCollectionCount() {
      document.getElementById('collectionCount').textContent = `My Collection (${wines.length})`;
    }

    function showSettings() {
      const apiKey = localStorage.getItem('openai_key') || '';
      document.getElementById('apiKeyInput').value = apiKey;
      showView('settingsView');
    }

    function saveSettings() {
      const apiKey = document.getElementById('apiKeyInput').value.trim();
      if (apiKey) {
        localStorage.setItem('openai_key', apiKey);
        alert('API key saved! AI wine recognition is now enabled.');
      } else {
        localStorage.removeItem('openai_key');
        alert('API key removed. Manual entry only.');
      }
      goHome();
    }

    // ELO Rating System for wine comparisons
    function calculateElo(winner, loser) {
      const K = 32; // K-factor (sensitivity)
      const expectedWinner = 1 / (1 + Math.pow(10, (loser.eloScore - winner.eloScore) / 400));
      const expectedLoser = 1 / (1 + Math.pow(10, (winner.eloScore - loser.eloScore) / 400));
      
      winner.eloScore = Math.round(winner.eloScore + K * (1 - expectedWinner));
      loser.eloScore = Math.round(loser.eloScore + K * (0 - expectedLoser));
      
      winner.comparisons = (winner.comparisons || 0) + 1;
      loser.comparisons = (loser.comparisons || 0) + 1;
    }

    function startComparison() {
      if (wines.length < 2) {
        alert('You need at least 2 wines to start ranking!');
        showCollection();
        return;
      }
      
      // Pick two random wines
      const shuffled = [...wines].sort(() => Math.random() - 0.5);
      currentComparison = [shuffled[0], shuffled[1]];
      
      displayComparison();
    }

    function startComparisonForWine(wineId) {
      if (wines.length < 2) {
        alert('You need at least 2 wines to compare!');
        return;
      }
      
      const wine = wines.find(w => w.id === wineId);
      const others = wines.filter(w => w.id !== wineId);
      const opponent = others[Math.floor(Math.random() * others.length)];
      
      currentComparison = [wine, opponent];
      displayComparison();
    }

    function displayComparison() {
      showView('comparisonView');
      
      const options = document.getElementById('comparisonOptions');
      options.innerHTML = currentComparison.map(wine => `
        <div class="wine-comparison-card" onclick="selectWinner(${wine.id})">
          <img src="${wine.image}" alt="${wine.name}">
          <h3>${wine.name}</h3>
          <p class="vintage">${wine.vintage || 'N/A'}</p>
        </div>
      `).join('');
    }

    function selectWinner(winnerId) {
      const winner = wines.find(w => w.id === winnerId);
      const loser = currentComparison.find(w => w.id !== winnerId);
      
      calculateElo(winner, loser);
      localStorage.setItem('wines', JSON.stringify(wines));
      
      // Ask if they want to continue
      if (confirm('Wine ranked! Compare another pair?')) {
        startComparison();
      } else {
        showCollection();
      }
    }

    function skipComparison() {
      if (confirm('Skip this comparison?')) {
        if (confirm('Compare a different pair?')) {
          startComparison();
        } else {
          showCollection();
        }
      }
    }

    // Initialize
    updateCollectionCount();
  </script>
</body>
</html>
