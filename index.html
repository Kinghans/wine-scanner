import { createClient } from 'https://esm.sh/@supabase/supabase-js@2'

const corsHeaders = {
  'Access-Control-Allow-Origin': '*',
  'Access-Control-Allow-Headers': 'authorization, x-client-info, apikey, content-type',
}

Deno.serve(async (req) => {
  if (req.method === 'OPTIONS') {
    return new Response('ok', { headers: corsHeaders })
  }

  try {
    const supabaseClient = createClient(
      Deno.env.get('SUPABASE_URL') ?? '',
      Deno.env.get('SUPABASE_ANON_KEY') ?? ''
    )

    // Get OpenAI key from database
    const { data: config } = await supabaseClient
      .from('app_config')
      .select('value')
      .eq('key', 'openai_api_key')
      .single()

    const openaiKey = config?.value
    if (!openaiKey) {
      return new Response(JSON.stringify({ error: 'OpenAI key not configured' }), {
        status: 500,
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      })
    }

    const body = await req.json()
    const { wineName, vintage, imageData, extractMenu } = body

    console.log('Request type:', { hasWineName: !!wineName, hasImageData: !!imageData, extractMenu })

    // MODE 1: Menu extraction (multi-wine from image)
    if (extractMenu && imageData) {
      console.log('Menu extraction mode')
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${openaiKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages: [
            {
              role: 'user',
              content: [
                {
                  type: 'text',
                  text: 'Extract ALL wines from this restaurant menu. For each wine, provide: name, vintage (if visible), producer (if visible), glass price, bottle price. Return as JSON array: [{name, vintage, producer, glassPrice, bottlePrice}]'
                },
                {
                  type: 'image_url',
                  image_url: { url: imageData }
                }
              ]
            }
          ],
          max_tokens: 2000
        })
      })

      const result = await response.json()
      const content = result.choices[0].message.content
      const wines = JSON.parse(content.replace(/```json\n?|\n?```/g, ''))

      return new Response(JSON.stringify({ wines }), {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      })
    }

    // MODE 2: Image extraction (single wine name/vintage from image)
    if (imageData && !wineName) {
      console.log('Image extraction mode')
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${openaiKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages: [
            {
              role: 'user',
              content: [
                {
                  type: 'text',
                  text: 'Extract the wine name and vintage from this label. Return ONLY JSON: {name: "wine name", vintage: "YYYY"}'
                },
                {
                  type: 'image_url',
                  image_url: { url: imageData }
                }
              ]
            }
          ],
          max_tokens: 100
        })
      })

      const result = await response.json()
      const content = result.choices[0].message.content
      const extracted = JSON.parse(content.replace(/```json\n?|\n?```/g, ''))

      console.log('Extracted:', extracted)
      return new Response(JSON.stringify(extracted), {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      })
    }

    // MODE 3: Text-based wine search with full details + flavor profiles
    if (wineName) {
      console.log('Text search mode:', wineName, vintage)
      const response = await fetch('https://api.openai.com/v1/chat/completions', {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${openaiKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          model: 'gpt-4o-mini',
          messages: [
            {
              role: 'system',
              content: 'You are a wine expert. Provide accurate information about wines including flavor profiles on a 1-5 scale. Always return valid JSON.'
            },
            {
              role: 'user',
              content: `Provide detailed information about "${wineName}" ${vintage ? vintage : ''}. Return ONLY valid JSON with this exact structure (no markdown, no code blocks):
{
  "name": "Full wine name",
  "vintage": "Year or null",
  "producer": "Producer name",
  "region": "Wine region",
  "country": "Country",
  "varietal": "Grape variety",
  "type": "red/white/rose/sparkling/dessert",
  "description": "2-3 sentence description",
  "tasting_notes": "Flavor notes",
  "food_pairings": "Food pairing suggestions",
  "price": "$X-Y range",
  "rating": 4.2,
  "body": 3,
  "tannin": 3,
  "sweetness": 2,
  "acidity": 4
}

CRITICAL: 
- type must be exactly one of: red, white, rose, sparkling, dessert (lowercase)
- body, tannin, sweetness, acidity must be integers 1-5
- tannin should be null if type is not "red"
- rating should be a decimal number like 4.2
- Return raw JSON only, no code blocks`
            }
          ],
          max_tokens: 800
        })
      })

      const result = await response.json()
      let content = result.choices[0].message.content
      
      // Clean up response - remove markdown code blocks if present
      content = content.replace(/```json\n?|\n?```/g, '').trim()
      
      const wineData = JSON.parse(content)
      
      // Validate and normalize
      if (!['red', 'white', 'rose', 'sparkling', 'dessert'].includes(wineData.type)) {
        wineData.type = 'red' // default
      }
      
      // Ensure flavor values are integers 1-5
      wineData.body = Math.max(1, Math.min(5, parseInt(wineData.body) || 3))
      wineData.sweetness = Math.max(1, Math.min(5, parseInt(wineData.sweetness) || 3))
      wineData.acidity = Math.max(1, Math.min(5, parseInt(wineData.acidity) || 3))
      
      // Tannin only for red wines
      if (wineData.type === 'red') {
        wineData.tannin = Math.max(1, Math.min(5, parseInt(wineData.tannin) || 3))
      } else {
        wineData.tannin = null
      }

      console.log('Wine data:', wineData)
      return new Response(JSON.stringify(wineData), {
        headers: { ...corsHeaders, 'Content-Type': 'application/json' }
      })
    }

    // No valid mode detected
    return new Response(JSON.stringify({ error: 'Invalid request - need wineName or imageData' }), {
      status: 400,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    })

  } catch (error) {
    console.error('Error:', error)
    return new Response(JSON.stringify({ error: error.message }), {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'application/json' }
    })
  }
})
