<!DOCTYPE html>
<html>
<head>
  <title>Grapevine Edge Function Test</title>
  <style>
    body { font-family: system-ui; max-width: 800px; margin: 40px auto; padding: 20px; }
    button { padding: 12px 24px; background: #8B3A42; color: white; border: none; border-radius: 8px; cursor: pointer; margin: 8px; }
    button:hover { background: #6d2d33; }
    pre { background: #f5f5f5; padding: 16px; border-radius: 8px; overflow-x: auto; }
    .success { color: #28a745; }
    .error { color: #dc3545; }
  </style>
</head>
<body>
  <h1>üç∑ Grapevine Edge Function Test</h1>
  
  <h2>Test 1: Text Search (works without OpenAI)</h2>
  <button onclick="testTextSearch()">Test Text Search</button>
  <pre id="textResult">Click button to test...</pre>
  
  <h2>Test 2: Check OpenAI Key</h2>
  <button onclick="checkOpenAIKey()">Check OpenAI Key</button>
  <pre id="keyResult">Click button to test...</pre>
  
  <h2>Test 3: Image Extraction (requires OpenAI)</h2>
  <p>Take a photo of a wine label:</p>
  <input type="file" id="imageInput" accept="image/*" capture="environment">
  <button onclick="testImageExtraction()">Test Image Extraction</button>
  <pre id="imageResult">Upload image and click button...</pre>
  
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    const SUPABASE_URL = 'https://nzhjtwnpznqaehwegwvs.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im56aGp0d25wem5xYWVod2Vnd3ZzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjQ5NTEwMDIsImV4cCI6MjA4MDUyNzAwMn0.U5LNTTBuiX_seQewL8kOKno-XNCdRZcPOgFkHGpox_A';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    
    async function testTextSearch() {
      const result = document.getElementById('textResult');
      result.textContent = 'Testing...';
      
      try {
        const response = await fetch(`${SUPABASE_URL}/functions/v1/wine-search`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({ 
            wineName: 'Caymus Cabernet Sauvignon',
            vintage: '2020'
          })
        });
        
        const data = await response.json();
        result.className = 'success';
        result.textContent = 'SUCCESS!\n\n' + JSON.stringify(data, null, 2);
      } catch (err) {
        result.className = 'error';
        result.textContent = 'ERROR: ' + err.message;
      }
    }
    
    async function checkOpenAIKey() {
      const result = document.getElementById('keyResult');
      result.textContent = 'Checking...';
      
      try {
        const { data, error } = await supabase
          .from('app_config')
          .select('value')
          .eq('key', 'openai_api_key')
          .single();
        
        if (error) throw error;
        
        if (data && data.value) {
          result.className = 'success';
          result.textContent = 'SUCCESS! OpenAI key is configured.\n\nKey: ' + data.value.substring(0, 20) + '...';
        } else {
          result.className = 'error';
          result.textContent = 'ERROR: OpenAI key not found in database';
        }
      } catch (err) {
        result.className = 'error';
        result.textContent = 'ERROR: ' + err.message;
      }
    }
    
    async function testImageExtraction() {
      const result = document.getElementById('imageResult');
      const input = document.getElementById('imageInput');
      
      if (!input.files || !input.files[0]) {
        result.className = 'error';
        result.textContent = 'ERROR: Please select an image first';
        return;
      }
      
      result.textContent = 'Processing image...';
      
      try {
        // Convert image to base64
        const file = input.files[0];
        const reader = new FileReader();
        
        const imageData = await new Promise((resolve, reject) => {
          reader.onload = () => resolve(reader.result);
          reader.onerror = reject;
          reader.readAsDataURL(file);
        });
        
        // Call Edge Function
        const response = await fetch(`${SUPABASE_URL}/functions/v1/wine-search`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
          },
          body: JSON.stringify({ imageData })
        });
        
        const data = await response.json();
        
        if (data.name) {
          result.className = 'success';
          result.textContent = 'SUCCESS! Extracted wine info:\n\n' + JSON.stringify(data, null, 2);
        } else {
          result.className = 'error';
          result.textContent = 'ERROR: No wine name extracted\n\n' + JSON.stringify(data, null, 2);
        }
      } catch (err) {
        result.className = 'error';
        result.textContent = 'ERROR: ' + err.message;
      }
    }
  </script>
</body>
</html>
