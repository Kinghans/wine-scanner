<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#9333ea">
  <title>WineScan v2.0</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #faf5ff 0%, #fce7f3 100%);
      min-height: 100vh;
      padding-bottom: 20px;
    }
    .container { max-width: 500px; margin: 0 auto; }
    .header {
      background: linear-gradient(135deg, #9333ea 0%, #ec4899 100%);
      color: white;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 100;
    }
    .header-content {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }
    .header h1 {
      font-size: 24px;
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .btn {
      padding: 14px 24px;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.3s;
      width: 100%;
    }
    .btn-primary {
      background: linear-gradient(135deg, #9333ea 0%, #ec4899 100%);
      color: white;
      box-shadow: 0 4px 12px rgba(147, 51, 234, 0.3);
    }
    .btn-secondary {
      background: white;
      color: #9333ea;
      border: 2px solid #9333ea;
    }
    .btn-danger {
      background: #fee;
      color: #dc2626;
      border: none;
    }
    .content { padding: 20px; }
    .card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.08);
      margin-bottom: 16px;
    }
    .wine-icon { font-size: 64px; text-align: center; margin-bottom: 20px; }
    .text-center { text-align: center; }
    h2 { font-size: 24px; margin-bottom: 8px; color: #1f2937; }
    .subtitle { color: #6b7280; margin-bottom: 24px; }
    .wine-list { display: flex; flex-direction: column; gap: 12px; }
    .wine-item {
      background: white;
      border-radius: 12px;
      padding: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      gap: 16px;
      align-items: center;
    }
    .wine-item:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(0,0,0,0.12); }
    .wine-item-image {
      width: 60px;
      height: 60px;
      border-radius: 8px;
      object-fit: cover;
      flex-shrink: 0;
    }
    .wine-emoji {
      font-size: 40px;
      width: 60px;
      height: 60px;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      background: linear-gradient(135deg, #f3e8ff 0%, #fce7f3 100%);
      border-radius: 8px;
    }
    .wine-info { flex: 1; }
    .wine-name { font-weight: 600; color: #1f2937; margin-bottom: 4px; }
    .wine-meta { font-size: 14px; color: #6b7280; }
    .rank-section { display: flex; gap: 4px; margin-top: 4px; align-items: center; }
    .rank-badge {
      background: linear-gradient(135deg, #9333ea 0%, #ec4899 100%);
      color: white;
      padding: 4px 12px;
      border-radius: 12px;
      font-weight: 600;
      font-size: 14px;
    }
    .rank-badge.unranked { background: #e5e7eb; color: #6b7280; }
    .hidden { display: none !important; }
    .camera-container {
      position: relative;
      width: 100%;
      height: 500px;
      background: #000;
      border-radius: 12px;
      overflow: hidden;
      margin-bottom: 16px;
    }
    video { width: 100%; height: 100%; object-fit: cover; }
    .camera-overlay {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      border: 3px dashed rgba(255, 255, 255, 0.8);
      width: 70%;
      height: 75%;
      border-radius: 12px;
      pointer-events: none;
    }
    .camera-hint {
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 12px 20px;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
      max-width: 80%;
      z-index: 10;
    }
    .camera-controls {
      position: absolute;
      bottom: 20px;
      left: 0;
      right: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 20px;
      z-index: 10;
    }
    .capture-btn {
      width: 70px;
      height: 70px;
      border-radius: 50%;
      background: white;
      border: 4px solid #9333ea;
      cursor: pointer;
      transition: all 0.2s;
      position: relative;
    }
    .capture-btn::after {
      content: '';
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: #9333ea;
    }
    .flip-camera-btn {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      background: rgba(255, 255, 255, 0.9);
      border: none;
      cursor: pointer;
      font-size: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .processing { text-align: center; padding: 40px 20px; }
    .spinner {
      border: 4px solid #f3f4f6;
      border-top: 4px solid #9333ea;
      border-radius: 50%;
      width: 50px;
      height: 50px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    .form-group { margin-bottom: 16px; }
    label {
      display: block;
      font-weight: 600;
      margin-bottom: 8px;
      color: #374151;
      font-size: 14px;
    }
    input, textarea {
      width: 100%;
      padding: 12px;
      border: 2px solid #e5e7eb;
      border-radius: 8px;
      font-size: 16px;
      font-family: inherit;
    }
    input:focus, textarea:focus {
      outline: none;
      border-color: #9333ea;
    }
    textarea { resize: vertical; min-height: 100px; }
    .btn-group { display: flex; gap: 12px; margin-top: 24px; }
    .close-btn, .settings-btn {
      background: none;
      border: none;
      color: white;
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: background 0.2s;
    }
    .close-btn { font-size: 28px; }
    .image-preview { width: 100%; border-radius: 12px; margin-bottom: 16px; }
    .image-placeholder {
      text-align: center;
      padding: 60px;
      background: linear-gradient(135deg, #f3e8ff 0%, #fce7f3 100%);
      border-radius: 12px;
      margin-bottom: 16px;
    }
    .image-placeholder .icon { font-size: 120px; }
    .fab {
      position: fixed;
      bottom: 24px;
      right: 24px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: linear-gradient(135deg, #9333ea 0%, #ec4899 100%);
      color: white;
      border: none;
      font-size: 32px;
      cursor: pointer;
      box-shadow: 0 4px 12px rgba(147, 51, 234, 0.4);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .file-input { display: none; }
    .option-buttons { display: flex; gap: 12px; flex-direction: column; }
    .help-text { font-size: 12px; color: #6b7280; margin-top: 4px; }
    .skip-scan { margin-top: 12px; text-align: center; }
    .skip-scan button {
      background: none;
      border: none;
      color: #9333ea;
      text-decoration: underline;
      cursor: pointer;
      font-size: 14px;
    }
    .comparison-options { display: flex; gap: 12px; margin-bottom: 24px; }
    .wine-comparison-card {
      flex: 1;
      background: white;
      border: 3px solid #e5e7eb;
      border-radius: 16px;
      padding: 20px;
      cursor: pointer;
      transition: all 0.3s;
      text-align: center;
    }
    .wine-comparison-card:hover {
      transform: translateY(-4px);
      border-color: #9333ea;
      box-shadow: 0 8px 20px rgba(147, 51, 234, 0.2);
    }
    .wine-comparison-card img {
      width: 100%;
      height: 150px;
      object-fit: cover;
      border-radius: 12px;
      margin-bottom: 12px;
    }
    .wine-comparison-card .wine-icon-large {
      font-size: 64px;
      margin-bottom: 12px;
      padding: 20px;
      background: linear-gradient(135deg, #f3e8ff 0%, #fce7f3 100%);
      border-radius: 12px;
    }
    .wine-comparison-card h3 { font-size: 16px; margin-bottom: 4px; color: #1f2937; }
    .wine-comparison-card .vintage { font-size: 14px; color: #6b7280; }
    .comparison-prompt {
      text-align: center;
      margin-bottom: 24px;
      color: #6b7280;
      font-size: 18px;
      font-weight: 500;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="header-content">
        <h1><span>üç∑</span><span>WineScan</span></h1>
        <div style="display: flex; gap: 8px;">
          <button class="settings-btn" onclick="showSettings()">‚öôÔ∏è</button>
          <button class="close-btn hidden" onclick="goHome()">√ó</button>
        </div>
      </div>
    </div>

    <div id="homeView" class="content">
      <div class="card text-center">
        <div class="wine-icon">üç∑</div>
        <h2>Discover & Track Wines</h2>
        <p class="subtitle">Scan labels, save favorites, build your collection</p>
        <div class="option-buttons">
          <button class="btn btn-primary" onclick="startCamera()">
            <span>üì∑</span><span>Take Photo</span>
          </button>
          <button class="btn btn-secondary" onclick="document.getElementById('fileInput').click()">
            <span>üñºÔ∏è</span><span>Upload from Library</span>
          </button>
          <button class="btn btn-secondary" onclick="manualEntry()">
            <span>‚úçÔ∏è</span><span>Enter Manually</span>
          </button>
        </div>
        <input type="file" id="fileInput" class="file-input" accept="image/*" onchange="handleFileUpload(event)">
        <div style="height: 24px"></div>
        <button class="btn btn-secondary" onclick="showCollection()">
          <span>üç∑</span><span id="collectionCount">My Collection (0)</span>
        </button>
      </div>
    </div>

    <div id="cameraView" class="content hidden">
      <div class="card">
        <h2>Scan Wine Label</h2>
        <p class="subtitle">Center the label in the frame</p>
        <div class="camera-container">
          <video id="video" autoplay playsinline></video>
          <div class="camera-overlay"></div>
          <div class="camera-hint">Position label vertically in frame</div>
          <div class="camera-controls">
            <button class="flip-camera-btn" onclick="flipCamera()">üîÑ</button>
            <button class="capture-btn" onclick="capturePhoto()"></button>
          </div>
        </div>
        <div class="skip-scan"><button onclick="manualEntry()">Skip scan and enter manually</button></div>
        <div style="height: 12px"></div>
        <button class="btn btn-secondary" onclick="goHome()">Cancel</button>
      </div>
    </div>

    <div id="processingView" class="content hidden">
      <div class="card processing">
        <div class="spinner"></div>
        <h2>Processing...</h2>
        <p class="subtitle" id="processingStatus">Extracting wine information</p>
      </div>
    </div>

    <div id="resultView" class="content hidden">
      <div class="card">
        <div id="imageContainer"></div>
        <h2>Wine Details</h2>
        <p class="subtitle">Edit any fields as needed</p>
        <div class="form-group">
          <label>Wine Name *</label>
          <input type="text" id="wineName" placeholder="e.g., Ch√¢teau Margaux">
          <div class="help-text">Required field</div>
        </div>
        <div class="form-group">
          <label>Vintage Year</label>
          <input type="number" id="wineVintage" placeholder="e.g., 2018" min="1900" max="2025">
        </div>
        <div class="form-group">
          <label>Producer / Winery</label>
          <input type="text" id="wineProducer" placeholder="e.g., Ch√¢teau Margaux">
        </div>
        <div class="form-group">
          <label>Region / Appellation</label>
          <input type="text" id="wineRegion" placeholder="e.g., Bordeaux, France">
        </div>
        <div class="form-group">
          <label>Varietal / Blend</label>
          <input type="text" id="wineVarietal" placeholder="e.g., Cabernet Sauvignon">
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="saveWine()" style="flex: 2">
            <span>üíæ</span><span>Save to Collection</span>
          </button>
          <button class="btn btn-secondary" onclick="goHome()" style="flex: 1">Cancel</button>
        </div>
      </div>
    </div>

    <div id="collectionView" class="content hidden">
      <h2 style="margin-bottom: 16px; color: #1f2937;">My Wines</h2>
      <div id="wineList" class="wine-list"></div>
      <div id="emptyState" class="card text-center hidden">
        <div class="wine-icon">üç∑</div>
        <h2>No wines yet</h2>
        <p class="subtitle">Start scanning to build your collection!</p>
      </div>
    </div>

    <div id="detailView" class="content hidden">
      <div class="card" id="detailCard"></div>
    </div>

    <div id="settingsView" class="content hidden">
      <div class="card">
        <h2>Settings</h2>
        <p class="subtitle">Configure AI wine recognition</p>
        <div class="form-group">
          <label>OpenAI API Key</label>
          <input type="password" id="apiKeyInput" placeholder="sk-...">
          <div class="help-text">Get your API key from <a href="https://platform.openai.com/api-keys" target="_blank" style="color: #9333ea;">platform.openai.com</a></div>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="saveSettings()">
            <span>üíæ</span><span>Save API Key</span>
          </button>
          <button class="btn btn-secondary" onclick="goHome()">Cancel</button>
        </div>
      </div>
    </div>

    <div id="sentimentView" class="content hidden">
      <div class="card text-center">
        <div class="wine-icon">üç∑</div>
        <h2 id="sentimentWineName">Wine Name</h2>
        <p class="subtitle">How did you feel about this wine?</p>
        <div class="option-buttons">
          <button class="btn btn-primary" onclick="setSentiment('yes')" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%);">
            <span>üòç</span><span>I Loved It</span>
          </button>
          <button class="btn btn-secondary" onclick="setSentiment('ok')">
            <span>üòä</span><span>It Was OK</span>
          </button>
          <button class="btn btn-secondary" onclick="setSentiment('no')" style="border-color: #dc2626; color: #dc2626;">
            <span>üòê</span><span>Didn't Like It</span>
          </button>
        </div>
        <div style="margin-top: 24px;">
          <button class="btn btn-secondary" onclick="skipRanking()">Skip Ranking</button>
        </div>
      </div>
    </div>

    <div id="comparisonView" class="content hidden">
      <div class="card">
        <h2>Rank Your Wine</h2>
        <p class="comparison-prompt">Which wine did you prefer?</p>
        <div class="comparison-options" id="comparisonOptions"></div>
        <button class="btn btn-secondary" onclick="finishRanking()">Done Ranking</button>
      </div>
    </div>

    <button class="fab hidden" id="fab" onclick="startCamera()">üì∑</button>
  </div>

  <script>
    let wines = JSON.parse(localStorage.getItem('wines') || '[]');
    let currentWineId = null;
    let stream = null;
    let facingMode = 'environment';
    let currentComparison = null;
    let currentImageData = null;

    function isValidImage(img) {
      return img && typeof img === 'string' && img.startsWith('data:image/') && img.length > 100;
    }

    // Clean existing data
    wines = wines.map(w => ({...w, image: isValidImage(w.image) ? w.image : null, score: w.score || null, sentiment: w.sentiment || null, comparisons: w.comparisons || 0}));
    localStorage.setItem('wines', JSON.stringify(wines));

    function showView(v) {
      ['homeView','cameraView','processingView','resultView','collectionView','detailView','settingsView','sentimentView','comparisonView'].forEach(id => document.getElementById(id).classList.add('hidden'));
      document.getElementById(v).classList.remove('hidden');
      document.querySelector('.close-btn').classList.toggle('hidden', v === 'homeView');
      document.getElementById('fab').classList.toggle('hidden', v === 'homeView' || v === 'cameraView');
    }

    function goHome() {
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
      currentImageData = null;
      showView('homeView');
    }

    async function startCamera() {
      showView('cameraView');
      try {
        if (stream) stream.getTracks().forEach(t => t.stop());
        stream = await navigator.mediaDevices.getUserMedia({video: {facingMode}, audio: false});
        document.getElementById('video').srcObject = stream;
      } catch (err) {
        alert('Camera access denied');
        goHome();
      }
    }

    async function flipCamera() {
      facingMode = facingMode === 'environment' ? 'user' : 'environment';
      await startCamera();
    }

    function capturePhoto() {
      const v = document.getElementById('video');
      const c = document.createElement('canvas');
      c.width = v.videoWidth;
      c.height = v.videoHeight;
      c.getContext('2d').drawImage(v, 0, 0);
      if (stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
      currentImageData = c.toDataURL('image/jpeg', 0.9);
      processImage(currentImageData);
    }

    function handleFileUpload(e) {
      const f = e.target.files[0];
      if (f) {
        const r = new FileReader();
        r.onload = e => { currentImageData = e.target.result; processImage(e.target.result); };
        r.readAsDataURL(f);
      }
    }

    async function processImage(img) {
      showView('processingView');
      const c = document.getElementById('imageContainer');
      c.innerHTML = `<img src="${img}" class="image-preview">`;
      document.getElementById('wineName').value = '';
      document.getElementById('wineVintage').value = '';
      document.getElementById('wineProducer').value = '';
      document.getElementById('wineRegion').value = '';
      document.getElementById('wineVarietal').value = '';
      showView('resultView');
    }

    function manualEntry() {
      currentImageData = null;
      const c = document.getElementById('imageContainer');
      c.innerHTML = '<div class="image-placeholder"><div class="icon">üç∑</div></div>';
      document.getElementById('wineName').value = '';
      document.getElementById('wineVintage').value = '';
      document.getElementById('wineProducer').value = '';
      document.getElementById('wineRegion').value = '';
      document.getElementById('wineVarietal').value = '';
      showView('resultView');
    }

    function saveWine() {
      const n = document.getElementById('wineName').value.trim();
      if (!n) { alert('Please enter a wine name'); return; }
      const w = {
        id: Date.now(),
        name: n,
        vintage: document.getElementById('wineVintage').value || '',
        producer: document.getElementById('wineProducer').value || '',
        region: document.getElementById('wineRegion').value || '',
        varietal: document.getElementById('wineVarietal').value || '',
        score: null,
        sentiment: null,
        comparisons: 0,
        notes: '',
        image: isValidImage(currentImageData) ? currentImageData : null,
        dateAdded: new Date().toISOString().split('T')[0]
      };
      wines.unshift(w);
      localStorage.setItem('wines', JSON.stringify(wines));
      updateCollectionCount();
      currentWineId = w.id;
      currentImageData = null;
      showSentimentPrompt();
    }

    function showCollection() {
      const list = document.getElementById('wineList');
      const empty = document.getElementById('emptyState');
      if (wines.length === 0) {
        list.innerHTML = '';
        empty.classList.remove('hidden');
      } else {
        empty.classList.add('hidden');
        const sorted = [...wines].sort((a, b) => (b.score || 0) - (a.score || 0));
        list.innerHTML = sorted.map(w => `
          <div class="wine-item" onclick="showDetail(${w.id})">
            ${isValidImage(w.image) ? `<img src="${w.image}" class="wine-item-image">` : `<div class="wine-emoji">üç∑</div>`}
            <div class="wine-info">
              <div class="wine-name">${w.name}</div>
              <div class="wine-meta">${w.vintage ? w.vintage + ' ‚Ä¢ ' : ''}${w.region || w.producer || 'Unknown'}</div>
              <div class="rank-section">
                <span class="rank-badge ${!w.score ? 'unranked' : ''}">${w.score ? w.score.toFixed(1) : 'Unranked'}</span>
              </div>
            </div>
          </div>
        `).join('');
      }
      showView('collectionView');
    }

    function showDetail(id) {
      const w = wines.find(x => x.id === id);
      currentWineId = id;
      const sent = {'yes': 'üòç Loved It', 'ok': 'üòä It Was OK', 'no': 'üòê Didn\'t Like It'};
      document.getElementById('detailCard').innerHTML = `
        ${isValidImage(w.image) ? `<img src="${w.image}" class="image-preview">` : '<div class="image-placeholder"><div class="icon">üç∑</div></div>'}
        <h2>${w.name}</h2>
        <p class="subtitle">${w.vintage || 'Vintage not specified'}</p>
        ${w.producer ? `<div class="form-group"><label>Producer</label><div style="color: #6b7280">${w.producer}</div></div>` : ''}
        ${w.region ? `<div class="form-group"><label>Region</label><div style="color: #6b7280">${w.region}</div></div>` : ''}
        ${w.varietal ? `<div class="form-group"><label>Varietal</label><div style="color: #6b7280">${w.varietal}</div></div>` : ''}
        <div class="form-group">
          <label>Your Rating</label>
          <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
            <span class="rank-badge ${!w.score ? 'unranked' : ''}" style="font-size: 24px;">${w.score ? w.score.toFixed(1) : 'Not yet ranked'}</span>
            ${w.sentiment ? `<span style="font-size: 18px;">${sent[w.sentiment]}</span>` : ''}
          </div>
          ${w.score ? `<div class="help-text">Based on ${w.comparisons} comparison${w.comparisons !== 1 ? 's' : ''}</div>` : ''}
          <div style="margin-top: 12px;">
            <button class="btn btn-secondary" onclick="reRankWine(${id})" style="width: auto; padding: 8px 16px; font-size: 14px;">
              ${w.score ? 'Re-rank Wine' : 'Rank Wine'}
            </button>
          </div>
        </div>
        <div class="form-group">
          <label>Tasting Notes</label>
          <textarea id="wineNotes" placeholder="Add your tasting notes...">${w.notes}</textarea>
        </div>
        <div class="form-group">
          <label>Date Added</label>
          <div style="color: #6b7280">${w.dateAdded}</div>
        </div>
        <div class="btn-group">
          <button class="btn btn-primary" onclick="saveNotes()"><span>üíæ</span><span>Save Notes</span></button>
          <button class="btn btn-danger" onclick="deleteWine()">üóëÔ∏è Delete</button>
        </div>
      `;
      showView('detailView');
    }

    function saveNotes() {
      wines.find(w => w.id === currentWineId).notes = document.getElementById('wineNotes').value;
      localStorage.setItem('wines', JSON.stringify(wines));
      alert('Notes saved!');
    }

    function deleteWine() {
      if (confirm('Delete this wine?')) {
        wines = wines.filter(w => w.id !== currentWineId);
        localStorage.setItem('wines', JSON.stringify(wines));
        updateCollectionCount();
        showCollection();
      }
    }

    function updateCollectionCount() {
      document.getElementById('collectionCount').textContent = `My Collection (${wines.length})`;
    }

    function showSettings() {
      document.getElementById('apiKeyInput').value = localStorage.getItem('openai_key') || '';
      showView('settingsView');
    }

    function saveSettings() {
      const k = document.getElementById('apiKeyInput').value.trim();
      if (k) {
        localStorage.setItem('openai_key', k);
        alert('API key saved!');
      } else {
        localStorage.removeItem('openai_key');
        alert('API key removed.');
      }
      goHome();
    }

    function showSentimentPrompt() {
      const w = wines.find(x => x.id === currentWineId);
      document.getElementById('sentimentWineName').textContent = w.name;
      showView('sentimentView');
    }

    function setSentiment(s) {
      wines.find(w => w.id === currentWineId).sentiment = s;
      localStorage.setItem('wines', JSON.stringify(wines));
      startComparisonRanking(s);
    }

    function skipRanking() {
      if (confirm('Skip ranking? You can rank later from detail page.')) showCollection();
    }

    function reRankWine(id) {
      currentWineId = id;
      showSentimentPrompt();
    }

    function startComparisonRanking(s) {
      const w = wines.find(x => x.id === currentWineId);
      const same = wines.filter(x => x.sentiment === s && x.id !== currentWineId && x.score !== null);
      if (same.length === 0) {
        w.score = s === 'yes' ? 9.0 : s === 'ok' ? 5.5 : 2.0;
        w.comparisons = 0;
        recalculateAllScores();
        localStorage.setItem('wines', JSON.stringify(wines));
        showCollection();
        return;
      }
      currentComparison = {newWine: w, sentiment: s, comparisonResults: [], totalComparisons: 0};
      compareNextWine();
    }

    function compareNextWine() {
      const {newWine, sentiment, comparisonResults, totalComparisons} = currentComparison;
      const same = wines.filter(w => w.sentiment === sentiment && w.id !== newWine.id && w.score !== null);
      if (totalComparisons >= Math.min(5, same.length)) {
        calculateFinalScore();
        return;
      }
      const compared = comparisonResults.map(r => r.opponentId);
      const uncompared = same.filter(w => !compared.includes(w.id));
      const opp = uncompared.length > 0 ? uncompared[0] : same[Math.floor(Math.random() * same.length)];
      currentComparison.opponent = opp;
      displayComparison();
    }

    function displayComparison() {
      showView('comparisonView');
      const {newWine, opponent} = currentComparison;
      document.getElementById('comparisonOptions').innerHTML = `
        <div class="wine-comparison-card" onclick="selectWinner('new')">
          ${isValidImage(newWine.image) ? `<img src="${newWine.image}">` : '<div class="wine-icon-large">üç∑</div>'}
          <h3>${newWine.name}</h3>
          <p class="vintage">${newWine.vintage || 'N/A'}</p>
        </div>
        <div class="wine-comparison-card" onclick="selectWinner('opponent')">
          ${isValidImage(opponent.image) ? `<img src="${opponent.image}">` : '<div class="wine-icon-large">üç∑</div>'}
          <h3>${opponent.name}</h3>
          <p class="vintage">${opponent.vintage || 'N/A'}${opponent.score ? ' ‚Ä¢ ' + opponent.score.toFixed(1) : ''}</p>
        </div>
      `;
    }

    function selectWinner(winner) {
      const {newWine, opponent, comparisonResults} = currentComparison;
      comparisonResults.push({opponentId: opponent.id, opponentScore: opponent.score, newWineWon: winner === 'new'});
      currentComparison.totalComparisons++;
      compareNextWine();
    }

    function calculateFinalScore() {
      const {newWine, sentiment, comparisonResults} = currentComparison;
      const wins = comparisonResults.filter(r => r.newWineWon).length;
      const total = comparisonResults.length;
      const winRate = wins / total;
      const avgOpp = comparisonResults.reduce((sum, r) => sum + r.opponentScore, 0) / total;
      const adj = (winRate - 0.5) * 0.8;
      newWine.score = Math.max(getMinScore(sentiment), Math.min(getMaxScore(sentiment), avgOpp + adj));
      newWine.comparisons = total;
      recalculateAllScores();
      localStorage.setItem('wines', JSON.stringify(wines));
      finishRanking();
    }

    function recalculateAllScores() {
      ['yes', 'ok', 'no'].forEach(s => {
        const sw = wines.filter(w => w.sentiment === s && w.score !== null).sort((a, b) => b.score - a.score);
        if (sw.length === 0) return;
        const max = getMaxScore(s);
        const min = getMinScore(s);
        const range = max - min;
        sw.forEach((w, i) => {
          const rel = i / Math.max(1, sw.length - 1);
          w.score = max - (rel * range);
        });
      });
    }

    function getMaxScore(s) { return s === 'yes' ? 10.0 : s === 'ok' ? 7.0 : 4.0; }
    function getMinScore(s) { return s === 'yes' ? 7.0 : s === 'ok' ? 4.1 : 1.0; }

    function finishRanking() {
      const w = wines.find(x => x.id === currentWineId);
      if (w.score !== null) alert(`Ranked! Your wine scored ${w.score.toFixed(1)}/10`);
      showCollection();
    }

    updateCollectionCount();
  </script>
</body>
</html>
